<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PORTATO â€” ì•„ì¹´ì´ë¸Œ</title>
  <link rel="preconnect" href="https://bks0c7yrb0.execute-api.ap-northeast-2.amazonaws.com">
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Sandoll ì›¹í°íŠ¸ */
    @import url('https://bks0c7yrb0.execute-api.ap-northeast-2.amazonaws.com/v1/api/css/drop_fontstream_css/?sid=gAAAAABkPXHo4qvpc1sn4CfuJL52Upc7AT8TVi8zpqX6aZtd3bQar6UDsPKea-00OVjtEVNfrYxuRy0KwyP7evvOGmFn-UJE3J2fgwZrrKxTO78AFSLAqGsk2yWcjZ17eIWeK8W_hEM0WwmzRDJ8PY0OKk9vf2d1gDahwuKJRCRKWS-LyUCxQDP7meUclfmM9WUoaP-N0gjIL5lyx-sFjuMGMGstTkeslXuA25WmkTdqzwQN4zkCffosmIAvef50EDHxTj2cl6OL');
    
    :root { 
      --ink: #ebfeb3; 
      --bg: #3C6C71; 
      --accent: #2d5a5f;
      --font-main: 'Sandoll SuPil', sans-serif;
      --font-sub: 'Sandoll Gwanghwamun', serif;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: var(--font-main);
      background: var(--bg);
      color: var(--ink);
      overflow-x: visible; /* í—¤ë”ê°€ ì˜ë¦¬ì§€ ì•Šë„ë¡ visibleë¡œ ì„¤ì • */
      overflow-y: auto;
      min-width: 0;
    }
    
    /* í—¤ë” ì»¨í…Œì´ë„ˆ */
    .header-container {
      position: fixed;
      top: 2vh; /* ì—¬ë°± ì¤„ì„ */
      left: 2vw; /* ì¢Œìƒë‹¨ìœ¼ë¡œ ë” ì´ë™ */
      z-index: 2000;
      pointer-events: none;
      padding: 0; /* ì—¬ë°± ì œê±° */
      margin: 0;
      box-sizing: content-box;
      overflow: visible !important;
      width: auto;
      max-width: none;
      min-width: max-content;
      background: transparent;
    }
    
    /* í—¤ë” */
    .header {
      position: relative;
      display: inline-block;
      white-space: nowrap;
      overflow: visible !important;
      width: auto !important;
      max-width: none !important;
      min-width: max-content;
      box-sizing: content-box;
      padding: 0;
      margin: 0;
    }
    
    .header h1 {
      font-family: 'Sandoll SuPil', sans-serif;
      font-size: clamp(2.5vw, 4vmin, 3.5vw);
      font-weight: 900; /* ê°€ì¥ ë³¼ë“œ */
      margin: 0 !important;
      padding: 0 !important;
      color: #77B975 !important;
      letter-spacing: 0.05em;
      white-space: nowrap !important;
      overflow: visible !important;
      text-overflow: clip !important;
      width: auto !important;
      max-width: none !important;
      min-width: max-content !important;
      display: inline-block !important;
      line-height: 1.2;
      visibility: visible !important;
      opacity: 1 !important;
      transform: none !important;
      word-wrap: normal !important;
      word-break: normal !important;
      hyphens: none !important;
      text-align: left !important;
    }
    
    .bg {
      position: fixed;
      inset: 0;
      background: url("archive/background.png") center/cover no-repeat;
      z-index: 0;
      pointer-events: none;
    }
    
    #bgStack {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
    }
    
    #bgStack #bgLayer {
      position: absolute;
      inset: 0;
      background: url("archive/background.png") center/cover no-repeat;
    }
    
    #bgStack #screenOverlay {
      position: absolute;
      inset: 0;
      background: transparent;
    }
    
    .ui-root {
      position: relative;
      z-index: 10;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2vw;
      box-sizing: border-box;
      overflow: visible; /* í—¤ë”ê°€ ë³´ì´ë„ë¡ */
      max-width: none;
      width: 100%;
    }
    
    .archive-stats {
      position: fixed;
      top: 3vh;
      right: 3vw;
      z-index: 2000;
      pointer-events: none;
      text-align: right;
    }
    
    .archive-stats .stat-line {
      font-family: 'Sandoll SuPil', sans-serif;
      font-size: clamp(1.2vw, 2vmin, 1.8vw);
      font-weight: 600;
      color: #77B975;
      margin: 0;
      margin-bottom: 0.5vh;
      line-height: 1.4;
      white-space: nowrap;
    }
    
    .archive-stats .stat-number {
      font-weight: 900;
      font-size: 1.1em;
    }
    
    .archive-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      min-height: 100vh;
      overflow: visible; /* í—¤ë”ê°€ ë³´ì´ë„ë¡ visibleë¡œ ë³€ê²½ */
      padding: 0;
    }
    
    .archive-grid {
      position: relative;
      width: 100%;
      height: 100%;
      min-height: calc(100vh - 300px);
      margin-bottom: 3vw;
    }
    
    .archive-item {
      position: absolute;
      background: transparent;
      border: none;
      border-radius: 15px;
      padding: 0;
      backdrop-filter: none;
      box-shadow: none;
      cursor: pointer;
      /* CSS ì• ë‹ˆë©”ì´ì…˜ì€ ë¹„í™œì„±í™” (ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ì´ ì²˜ë¦¬) */
      /* animation: float 8s ease-in-out infinite; */
      transition: transform 0.1s linear, z-index 0.3s ease;
      --rotate: 0deg; /* ê¸°ë³¸ rotate ê°’ */
      --rotate-delta: 0deg; /* ì• ë‹ˆë©”ì´ì…˜ ì¤‘ íšŒì „ ë³€ë™ëŸ‰ */
      will-change: transform;
    }
    
    .archive-item:hover {
      /* hover ì‹œ ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ ì¼ì‹œ ì •ì§€ */
      z-index: 100;
      filter: drop-shadow(0 10px 20px rgba(235, 254, 179, 0.3));
    }
    
    /* ì¼ê´„ ì‚­ì œ ë²„íŠ¼ */
    .clear-archive-btn {
      position: fixed;
      bottom: 8vh;
      right: 3vw;
      background: rgba(60, 108, 113, 0.8);
      border: 2px solid rgba(235, 254, 179, 0.6);
      color: var(--ink);
      padding: 1vw 2vw;
      border-radius: 25px;
      font-size: clamp(0.9vw, 1.6vmin, 1.3vw);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 1000;
      font-family: var(--font-main);
    }
    
    .clear-archive-btn:hover {
      background: rgba(60, 108, 113, 0.95);
      border-color: rgba(235, 254, 179, 0.9);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    /* ì˜¤ë²„ë ˆì´ ë¼ì¸ ìŠ¤íƒ€ì¼ */
    .overlay-line-wrapper {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }
    
    .overlay-line {
      width: 100%;
      height: 100%;
      object-fit: contain;
      opacity: 0.9;
    }
    
    .overlay-text {
      position: absolute;
      left: calc(100% + 20px);
      top: 50%;
      transform: translateY(-50%);
      background: rgba(254, 255, 238, 0.85);
      color: #609BA1;
      padding: 0;
      border-radius: 0;
      font-family: 'Sandoll SuPil', sans-serif;
      font-size: clamp(0.8vw, 1.2vmin, 1.8vw);
      font-weight: 900;
      line-height: 1.4;
      z-index: 10001;
      pointer-events: none;
      box-shadow: none;
      border: none;
      max-width: none;
      white-space: normal;
    }
    
    .overlay-text .selection-item {
      display: block;
      white-space: nowrap;
      margin-bottom: 0.1vw;
    }
    
    .overlay-text .selection-item:last-child {
      margin-bottom: 0;
    }
    
    .overlay-text .selection-title {
      font-weight: 900;
      font-size: 1.1em;
      margin-bottom: 0.3vw;
      display: block;
    }
    
    /* í‹°ì¼“ ì •ë³´ ìŠ¤íƒ€ì¼ */
    .archive-stage-info {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      /* bottomì€ JavaScriptì—ì„œ ê·¸ë˜í”½ í¬ê¸°ì— ë¹„ë¡€í•˜ì—¬ ë™ì ìœ¼ë¡œ ì„¤ì • */
      background: transparent;
      color: #609BA1;
      font-family: 'Sandoll SuPil', sans-serif;
      /* font-sizeëŠ” JavaScriptì—ì„œ ê·¸ë˜í”½ í¬ê¸°ì— ë¹„ë¡€í•˜ì—¬ ë™ì ìœ¼ë¡œ ì„¤ì • */
      font-weight: 600;
      line-height: 1.2;
      white-space: normal;
      z-index: 51;
      pointer-events: none;
      max-width: none;
      text-align: center;
    }
    
    .archive-stage-info .stage-name {
      display: block;
      margin-bottom: 0.2vw;
      font-weight: 600;
    }
    
    .archive-stage-info .stage-datetime {
      display: block;
      font-weight: 600;
      line-height: 1.1;
    }
    
    .overlay-text .selection-details {
      font-size: 0.95em;
      opacity: 0.95;
    }
    
    @keyframes float {
      0%, 100% {
        transform: translateY(0px) translateX(0px) rotate(calc(var(--rotate, 0deg) + var(--rotate-delta, 0deg)));
      }
      12.5% {
        transform: translateY(-40px) translateX(25px) rotate(calc(var(--rotate, 0deg) + var(--rotate-delta, 0deg) + 8deg));
      }
      25% {
        transform: translateY(-30px) translateX(-20px) rotate(calc(var(--rotate, 0deg) + var(--rotate-delta, 0deg) + 15deg));
      }
      37.5% {
        transform: translateY(-50px) translateX(15px) rotate(calc(var(--rotate, 0deg) + var(--rotate-delta, 0deg) + 10deg));
      }
      50% {
        transform: translateY(-20px) translateX(-30px) rotate(calc(var(--rotate, 0deg) + var(--rotate-delta, 0deg) - 12deg));
      }
      62.5% {
        transform: translateY(-35px) translateX(20px) rotate(calc(var(--rotate, 0deg) + var(--rotate-delta, 0deg) - 8deg));
      }
      75% {
        transform: translateY(-25px) translateX(-15px) rotate(calc(var(--rotate, 0deg) + var(--rotate-delta, 0deg) + 5deg));
      }
      87.5% {
        transform: translateY(-45px) translateX(10px) rotate(calc(var(--rotate, 0deg) + var(--rotate-delta, 0deg) - 5deg));
      }
    }
    
    .ticket-image {
      width: 100%;
      height: auto;
      border-radius: 10px;
      margin-bottom: 1vw;
      background: transparent;
    }
    
    /* ì•„ì¹´ì´ë¸Œ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ ê°•ì œ ì œê±° */
    .ticket-container img {
      border: 0 !important;
      outline: 0 !important;
      background: transparent !important;
      box-shadow: none !important;
      filter: none !important;
    }
    
    .ticket-info {
      text-align: center;
      /* margin-topì€ JavaScriptì—ì„œ ê·¸ë˜í”½ í¬ê¸°ì— ë¹„ë¡€í•˜ì—¬ ë™ì ìœ¼ë¡œ ì„¤ì • */
    }
    
    .ticket-date {
      font-size: clamp(0.8vw, 1.4vmin, 1.2vw);
      color: rgba(235,254,179,0.7);
      margin-bottom: 0.5vw;
    }
    
    .ticket-id {
      font-size: clamp(0.7vw, 1.2vmin, 1vw);
      color: rgba(235,254,179,0.5);
      font-family: monospace;
    }
    
    .empty-state {
      text-align: center;
      padding: 4vw;
      color: rgba(235,254,179,0.6);
    }
    
    .empty-state h3 {
      font-size: clamp(1.8vw, 3vmin, 2.2vw);
      margin-bottom: 1vw;
      color: var(--ink);
    }
    
    .empty-state p {
      font-size: clamp(1vw, 1.8vmin, 1.5vw);
      margin-bottom: 2vw;
    }
    
    .btn {
      background: linear-gradient(135deg, var(--accent) 0%, #1e4a4d 100%);
      border: 2px solid var(--ink);
      color: var(--ink);
      padding: 1vw 2vw;
      border-radius: 25px;
      font-size: clamp(1vw, 1.8vmin, 1.5vw);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn:hover {
      background: linear-gradient(135deg, var(--ink) 0%, #d4f4a8 100%);
      color: var(--bg);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .footer {
      position: fixed;
      bottom: 2vh;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1vw;
      opacity: 0.9;
      z-index: 21;
      color: var(--ink);
      text-align: center;
    }
    
    
    @media (max-width: 600px) {
      .archive-item {
        max-width: 100px;
        max-height: 100px;
      }
      
    }
  </style>
</head>
<body>
  <!-- ë°°ê²½ -->
  <div id="bgStack" aria-hidden="true">
    <div id="bgLayer"></div>
    <div id="screenOverlay"></div>
  </div>

  <!-- í—¤ë” ì»¨í…Œì´ë„ˆ -->
  <div class="header-container">
    <div class="header">
      <h1>PortATO ì•„ì¹´ì´ë¸Œ   â€”   </h1>
    </div>
  </div>
  
  <!-- í†µê³„ (body ì§í•˜ìœ„ë¡œ ì´ë™) -->
  <div class="archive-stats" id="archiveStats">
    <div class="stat-line">
      ì§€ê¸ˆê¹Œì§€ ìŒ“ì—¬ì˜¨ í¬ë¥´íƒ€í†  ê³µì—°ì˜ ìˆ˜<br>
      <span class="stat-number" id="totalCount">0</span>
    </div>
    <div class="stat-line">
      ì˜¤ëŠ˜ ìŒ“ì¸ í¬ë¥´íƒ€í†  ê³µì—°ì˜ ìˆ˜<br>
      <span class="stat-number" id="todayCount">0</span>
    </div>
  </div>

  <div class="ui-root">
    <!-- ì•„ì¹´ì´ë¸Œ ì»¨í…Œì´ë„ˆ -->
    <div class="archive-container">
      <div class="archive-grid" id="archiveGrid">
          <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
      </div>
      
      <!-- ë¹ˆ ìƒíƒœ -->
      <div class="empty-state" id="emptyState" style="display: none;">
        <h3>ì•„ì§ ì €ì¥ëœ í‹°ì¼“ì´ ì—†ìŠµë‹ˆë‹¤</h3>
        <p>ìƒˆë¡œìš´ í‹°ì¼“ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
        <a href="index.html" class="btn">ìƒˆ í‹°ì¼“ ë§Œë“¤ê¸°</a>
      </div>
    </div>
  </div>
  
  <!-- ì¼ê´„ ì‚­ì œ ë²„íŠ¼ -->
  <button class="clear-archive-btn" onclick="clearArchive()">ëª¨ë“  í‹°ì¼“ ì‚­ì œ</button>

  <footer class="footer">
    <small>Â© 2025 PORTATO</small>
  </footer>

  <script>
    const ARCHIVE_KEY = "portato_archive_v1";
    
    // ì•„ì¹´ì´ë¸Œ ë°ì´í„° ë¡œë“œ ë° í‘œì‹œ
    function loadArchive() {
      try {
        const archiveData = JSON.parse(localStorage.getItem(ARCHIVE_KEY) || '[]');
        console.log('ğŸ“š ì•„ì¹´ì´ë¸Œ ë°ì´í„°:', archiveData);
        
        // ê° ì•„ì´í…œì˜ ì´ë¯¸ì§€ ìœ„ì¹˜ ì •ë³´ ìƒì„¸ ë¡œê·¸
        archiveData.forEach((item, index) => {
          console.log(`ğŸ“‹ ì•„ì´í…œ ${index + 1}:`, item.id);
          console.log('   - imagePositions:', item.imagePositions);
          if (item.imagePositions) {
            item.imagePositions.forEach((img, imgIndex) => {
              console.log(`   - ì´ë¯¸ì§€ ${imgIndex + 1}:`, img.src, 'ìœ„ì¹˜:', img.left, img.top);
            });
          }
        });
        
        displayArchive(archiveData);
        displayArchiveStats(archiveData);
        
      } catch (error) {
        console.error('âŒ ì•„ì¹´ì´ë¸Œ ë¡œë“œ ì‹¤íŒ¨:', error);
        showEmptyState();
      }
    }
    
    // ì•„ì¹´ì´ë¸Œ í†µê³„ í‘œì‹œ
    function displayArchiveStats(archiveData) {
      const totalCount = archiveData.length;
      
      // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const todayCount = archiveData.filter(item => {
        const itemDate = new Date(item.timestamp);
        itemDate.setHours(0, 0, 0, 0);
        return itemDate.getTime() === today.getTime();
      }).length;
      
      // í†µê³„ ì—…ë°ì´íŠ¸
      const totalCountEl = document.getElementById('totalCount');
      const todayCountEl = document.getElementById('todayCount');
      
      if (totalCountEl) {
        totalCountEl.textContent = totalCount;
      }
      if (todayCountEl) {
        todayCountEl.textContent = todayCount;
      }
      
      console.log(`ğŸ“Š ì•„ì¹´ì´ë¸Œ í†µê³„: ì´ ${totalCount}ê°œ, ì˜¤ëŠ˜ ${todayCount}ê°œ`);
    }
    
    // ì•„ì¹´ì´ë¸Œ í‘œì‹œ
    function displayArchive(archiveData) {
      const archiveGrid = document.getElementById('archiveGrid');
      const emptyState = document.getElementById('emptyState');
      
      if (archiveData.length === 0) {
        archiveGrid.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }
      
      archiveGrid.style.display = 'block';
      emptyState.style.display = 'none';
      
      // ìµœì‹  ìˆœìœ¼ë¡œ ì •ë ¬
      const sortedData = archiveData.sort((a, b) => b.timestamp - a.timestamp);
      
      // í•­ëª© ê°œìˆ˜ì™€ í™”ë©´ ë¹„ìœ¨ì— ë”°ë¥¸ í¬ê¸° ì¡°ì •
      const itemCount = sortedData.length;
      const gridWidth = window.innerWidth - 100;
      const gridHeight = window.innerHeight - 200;
      const gridArea = gridWidth * gridHeight;
      
      let itemSize, maxImgSize;
      
      if (itemCount < 5) {
        // 5ê°œ ì „ê¹Œì§€: ë˜‘ê°™ì´ ì ë‹¹íˆ í° ìƒíƒœ ìœ ì§€ (ë„ˆë¬´ ì»¤ì§€ëŠ” ê²ƒ ë°©ì§€)
        itemSize = 250;
        maxImgSize = 250;
      } else {
        // 5ê°œ ì´í›„: í™”ë©´ì˜ ì¼ì • ë¹„ìœ¨ì„ ì±„ìš¸ ìˆ˜ ìˆë„ë¡ í¬ê¸° ê³„ì‚°
        // ê° ê·¸ë˜í”½ì´ í™”ë©´ ë©´ì ì˜ ì¼ì • ë¹„ìœ¨ì„ ì°¨ì§€í•˜ë„ë¡
        // ì˜ˆ: ê° ê·¸ë˜í”½ì´ í™”ë©´ì˜ 8~12% ì •ë„ ì°¨ì§€í•˜ë„ë¡
        const targetAreaPerItem = gridArea * 0.10; // í™”ë©´ ë©´ì ì˜ 10% (ì ë‹¹íˆ ì¡°ì • ê°€ëŠ¥)
        const estimatedItemArea = targetAreaPerItem / 1.5; // ì—¬ìœ  ê³µê°„ 1.5ë°° ê³ ë ¤
        itemSize = Math.sqrt(estimatedItemArea); // ì •ì‚¬ê°í˜• ê°€ì •
        maxImgSize = itemSize;
        
        // ìµœì†Œ/ìµœëŒ€ í¬ê¸° ì œí•œ
        const minSize = 100;
        const maxSize = 250;
        itemSize = Math.max(minSize, Math.min(maxSize, itemSize));
        maxImgSize = itemSize;
      }
      
      console.log(`ğŸ“Š ì•„ì¹´ì´ë¸Œ í•­ëª© ê°œìˆ˜: ${itemCount}ê°œ, ì•„ì´í…œ í¬ê¸°: ${itemSize}px`);
      
      archiveGrid.innerHTML = sortedData.map((item, index) => {
        
        const date = new Date(item.timestamp);
        const dateString = date.toLocaleDateString('ko-KR');
        const timeString = date.toLocaleTimeString('ko-KR', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        
        // right_circle.svg ë°°ê²½ì— ë“œë˜ê·¸ ì´ë¯¸ì§€ë“¤ í‘œì‹œ
        let ticketContent = '';
        let overlayContent = ''; // ì˜¤ë²„ë ˆì´ ë¼ì¸ê³¼ í…ìŠ¤íŠ¸
        
        // ì €ì¥ëœ right_circle ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ìš°ì„  ì‚¬ìš© (ê°€ì¥ ì •í™•)
        // íˆ¬ëª… ë°°ê²½ìœ¼ë¡œ ìº¡ì²˜ëœ ì™„ì „í•œ ì´ë¯¸ì§€ì´ë¯€ë¡œ, ì›ë³¸ í¬ê¸°ì™€ ë¹„ìœ¨ì„ ì •í™•íˆ ìœ ì§€
        // object-fit ì‚¬ìš© ì‹œ ë°°ì¹˜ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì´ë¯¸ì§€ ë¡œë“œ í›„ ìì—°ìŠ¤ëŸ¬ìš´ í¬ê¸° ìœ ì§€
        if (item.rightCircleImage) {
          ticketContent = `
            <div class="ticket-container" style="position: relative; display: inline-block; margin: 0 auto; background: transparent; line-height: 0;">
              <img src="${item.rightCircleImage}" alt="í‹°ì¼“ right_circle ì˜ì—­" 
                   style="display: block; width: auto; height: auto; max-width: ${maxImgSize}px; max-height: ${maxImgSize}px; border: 0 !important; outline: 0 !important; background: transparent !important; image-rendering: auto;"
                   onload="(function(img) {
                     // ì´ë¯¸ì§€ì˜ ìì—°ìŠ¤ëŸ¬ìš´ í¬ê¸°ë¥¼ ìœ ì§€í•˜ë©´ì„œ max í¬ê¸°ë§Œ ì œí•œ
                     const naturalWidth = img.naturalWidth;
                     const naturalHeight = img.naturalHeight;
                     const maxSize = ${maxImgSize};
                     
                     let displayWidth = naturalWidth;
                     let displayHeight = naturalHeight;
                     
                     // ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©´ì„œ max í¬ê¸° ë‚´ë¡œ ì¡°ì •
                     if (displayWidth > maxSize) {
                       const ratio = maxSize / displayWidth;
                       displayWidth = maxSize;
                       displayHeight = displayHeight * ratio;
                     }
                     if (displayHeight > maxSize) {
                       const ratio = maxSize / displayHeight;
                       displayHeight = maxSize;
                       displayWidth = displayWidth * ratio;
                     }
                     
                     img.style.width = displayWidth + 'px';
                     img.style.height = displayHeight + 'px';
                   })(this);">
            </div>
          `;
        } else if (item.imagePositions && item.imagePositions.length > 0) {
          // ì»¨í…Œì´ë„ˆë¥¼ ì •ì‚¬ê°í˜•ìœ¼ë¡œ ë§Œë“¤ì–´ ì›í˜• ëª¨ì–‘ ìœ ì§€
          // right_circle.svgë¥¼ ë°°ê²½ìœ¼ë¡œ ì‚¬ìš© (ì›í˜• ì»¨í…Œì´ë„ˆë¡œ ì œí•œ)
          ticketContent = `
            <div class="ticket-container" style="position: relative; width: 100%; aspect-ratio: 1; max-width: ${maxImgSize}px; max-height: ${maxImgSize}px; margin: 0 auto; background: url('result/ticket/right_circle.svg') no-repeat center center; background-size: contain;">
              ${item.imagePositions.map(imgData => {
                // ìƒˆ í˜•ì‹: relativeLeft, relativeTop ë“± ì‚¬ìš© (right_circle ê¸°ì¤€ 0~1 ë²”ìœ„)
                if (imgData.relativeLeft !== undefined) {
                  // right_circle.svgì˜ ì‹¤ì œ í‘œì‹œ ì˜ì—­ì„ ê¸°ì¤€ìœ¼ë¡œ í¼ì„¼íŠ¸ ë³€í™˜
                  // ìƒëŒ€ ìœ„ì¹˜ë¥¼ ê·¸ëŒ€ë¡œ í¼ì„¼íŠ¸ë¡œ ì‚¬ìš© (right_circle ë‚´ë¶€ ê¸°ì¤€)
                  const leftPercent = (imgData.relativeLeft * 100).toFixed(4);
                  const topPercent = (imgData.relativeTop * 100).toFixed(4);
                  const widthPercent = (imgData.relativeWidth * 100).toFixed(4);
                  const heightPercent = (imgData.relativeHeight * 100).toFixed(4);
                  
                  return `
                    <img src="${imgData.src}" alt="${imgData.alt || ''}"
                         style="position: absolute; left: ${leftPercent}%; top: ${topPercent}%; 
                                width: ${widthPercent}%; height: ${heightPercent}%; 
                                object-fit: contain; z-index: 10;
                                border: 0 !important; outline: 0 !important; background: transparent !important;
                                transform: ${imgData.transform || ''}; pointer-events: none;
                                transform-origin: center center;"
                         onerror="console.log('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', '${imgData.src}');">
                  `;
                }
                // í•˜ìœ„ í˜¸í™˜ì„±: ê¸°ì¡´ left/top í˜•ì‹
                else {
                  const leftPercent = parseFloat(imgData.left) || 0;
                  const topPercent = parseFloat(imgData.top) || 0;
                  let widthStyle = '';
                  let heightStyle = '';
                  
                  if (imgData.width && imgData.height) {
                    const width = parseFloat(imgData.width);
                    const height = parseFloat(imgData.height);
                    widthStyle = `${Math.max(width * 0.15, 8)}px`;
                    heightStyle = `${Math.max(height * 0.15, 8)}px`;
                  } else {
                    widthStyle = `${(parseFloat(imgData.width) || 10) * 0.5}%`;
                    heightStyle = 'auto';
                  }
                  
                  return `
                    <img src="${imgData.src}" alt="${imgData.alt || ''}"
                         style="position: absolute; left: ${leftPercent}%; top: ${topPercent}%; 
                                width: ${widthStyle}; height: ${heightStyle}; 
                                object-fit: contain; z-index: 10;
                                border: 0 !important; outline: 0 !important; background: transparent !important;
                                transform: ${imgData.transform || ''}; pointer-events: none;"
                         onerror="console.log('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', '${imgData.src}');">
                  `;
                }
              }).join('')}
            </div>
          `;
        } else if (item.rightImagePositions && item.rightImagePositions.length > 0) {
          // í•˜ìœ„ í˜¸í™˜ì„±: rightImagePositions ì‚¬ìš©
          ticketContent = `
            <div class="ticket-container" style="position: relative; width: 100%; aspect-ratio: 1; max-width: ${maxImgSize}px; max-height: ${maxImgSize}px; margin: 0 auto; background: url('result/ticket/right_circle.svg') no-repeat center center; background-size: contain;">
              ${item.rightImagePositions.map(imgData => `
                <img src="${imgData.src}" alt=""
                     style="position: absolute; right: ${imgData.right || 50}%; top: ${imgData.top || 50}%; 
                            width: auto; height: auto; max-width: 30px; max-height: 30px; z-index: 10;
                            border: 0 !important; outline: 0 !important; background: transparent !important;"
                     onload="this.style.width = (this.naturalWidth * ${imgData.alt.includes('ë°”ì´ì˜¬ë¦°') || imgData.alt.includes('ë¹„ì˜¬ë¼') || imgData.alt.includes('ì²¼ë¡œ') || imgData.alt.includes('íŠ¸ëŸ¼ë³¸') || imgData.alt.includes('íŠ¸ëŸ¼í«') || imgData.alt.includes('í˜¸ë¥¸') || imgData.alt.includes('í”Œë£»') || imgData.alt.includes('í´ë¼ë¦¬ë„·') || imgData.alt.includes('ì½˜íŠ¸ë¼ë² ì´ìŠ¤') ? '0.25' : '0.5'}) + 'px'; this.style.height = (this.naturalHeight * ${imgData.alt.includes('ë°”ì´ì˜¬ë¦°') || imgData.alt.includes('ë¹„ì˜¬ë¼') || imgData.alt.includes('ì²¼ë¡œ') || imgData.alt.includes('íŠ¸ëŸ¼ë³¸') || imgData.alt.includes('íŠ¸ëŸ¼í«') || imgData.alt.includes('í˜¸ë¥¸') || imgData.alt.includes('í”Œë£»') || imgData.alt.includes('í´ë¼ë¦¬ë„·') || imgData.alt.includes('ì½˜íŠ¸ë¼ë² ì´ìŠ¤') ? '0.25' : '0.5'}) + 'px';"
                     onerror="console.log('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', '${imgData.src}');">
              `).join('')}
            </div>
          `;
        } else {
          // ê¸°ì¡´ ìº¡ì³ ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš° (í•˜ìœ„ í˜¸í™˜ì„±)
          ticketContent = `
            <div class="ticket-container" style="position: relative; width: 100%; aspect-ratio: 1; max-width: ${maxImgSize}px; max-height: ${maxImgSize}px; margin: 0 auto; background: url('result/ticket/right_circle.svg') no-repeat center center; background-size: contain;">
              ${item.image ? `<img src="${item.image}" alt="í‹°ì¼“ ì´ë¯¸ì§€" style="width: 100%; height: 100%; object-fit: contain;">` : ''}
            </div>
          `;
        }

        // í°íŠ¸ í¬ê¸° ë™ì  ê³„ì‚° (ê·¸ë˜í”½ í¬ê¸°ì— ë¹„ë¡€í•˜ë˜ í…ìŠ¤íŠ¸ê°€ ê³¼ë„í•˜ê²Œ ì»¤ì§€ì§€ ì•Šë„ë¡)
        // 250pxë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ë˜, ê·¸ë˜í”½ í¬ê¸° ë³€í™”ì— í…ìŠ¤íŠ¸ëŠ” ë” ì‘ê²Œ ë°˜ì‘ (0.6ë°°)
        // ì˜ˆ: ê·¸ë˜í”½ì´ 100pxâ†’250px (2.5ë°°)ì¼ ë•Œ í…ìŠ¤íŠ¸ëŠ” 1.5ë°° ì •ë„ë§Œ ì»¤ì§
        const baseFontSize = 250; // ê¸°ì¤€ ê·¸ë˜í”½ í¬ê¸°
        const fontSizeRatio = 0.6; // í…ìŠ¤íŠ¸ ë³€í™” ë¹„ìœ¨ (ê·¸ë˜í”½ë³´ë‹¤ ì‘ê²Œ)
        const normalizedScale = 1 + (maxImgSize - baseFontSize) / baseFontSize * fontSizeRatio;
        // ì‹¤ì œ í”½ì…€ í¬ê¸°ë¡œ ê³„ì‚° (250px ê·¸ë˜í”½ ê¸°ì¤€ìœ¼ë¡œ 0.7vw ì •ë„)
        const baseFontSizePx = window.innerWidth * 0.007; // 0.7vwë¥¼ í”½ì…€ë¡œ ë³€í™˜ (ëŒ€ëµ)
        const stageInfoFontSizePx = baseFontSizePx * normalizedScale;
        const stageInfoFontSize = `${stageInfoFontSizePx}px`;
        
        // ì˜¤ë²„ë ˆì´ í…ìŠ¤íŠ¸ í¬ê¸° (ì•½ê°„ ë” ì‘ê²Œ)
        const overlayFontSizePx = baseFontSizePx * normalizedScale * 0.9;
        const overlayFontSize = `${overlayFontSizePx}px`;
        
        // ìŠ¤í…Œì´ì§€ ì •ë³´ ìƒì„±
        // ê·¸ë˜í”½ í¬ê¸°ì— ì •í™•íˆ ë¹„ë¡€í•˜ì—¬ í…ìŠ¤íŠ¸ ìœ„ì¹˜ ì¡°ì • (ë” ê°€ê¹ê²Œ)
        const baseSizeForPosition = 250; // ê¸°ì¤€ í¬ê¸°
        const positionScale = maxImgSize / baseSizeForPosition;
        // bottom ìœ„ì¹˜ë¥¼ ê·¸ë˜í”½ í¬ê¸°ì— ë¹„ë¡€í•˜ì—¬ ì¡°ì • (250pxì¼ ë•Œ -20pxë¡œ ì¤„ì—¬ì„œ ë” ê°€ê¹ê²Œ)
        const bottomOffset = -20 * positionScale;
        
        let stageInfoHTML = '';
        if (item.selections) {
          const stageInfo = generateStageInfo(item.selections, item.timestamp);
          if (stageInfo) {
            stageInfoHTML = `
              <div class="archive-stage-info" style="font-size: ${stageInfoFontSize}; bottom: ${bottomOffset}px;">
                <span class="stage-name">${stageInfo.stageName}</span>
                <span class="stage-datetime">${stageInfo.dateTime}</span>
              </div>
            `;
          }
        }
        
        // ticket-info ìœ„ì¹˜ë„ ê·¸ë˜í”½ í¬ê¸°ì— ë¹„ë¡€í•˜ì—¬ ì¡°ì • (ë” ê°€ê¹ê²Œ)
        const ticketInfoTopOffset = maxImgSize * 0.03; // ê·¸ë˜í”½ í¬ê¸°ì˜ 3% ì•„ë˜
        
        return `
          <div class="archive-item" onclick="viewTicket('${item.id}')">
            ${ticketContent}
            ${stageInfoHTML}
            <div class="ticket-info" style="margin-top: ${ticketInfoTopOffset}px;">
              <div class="ticket-date">${dateString} ${timeString}</div>
            </div>
          </div>
        `;
      }).join('');
      
      // ì»¨í…Œì´ë„ˆ í¬ê¸° ê³„ì‚° (DOMì´ ë Œë”ë§ëœ í›„)
      setTimeout(() => {
        const gridWidth = archiveGrid.offsetWidth || window.innerWidth - 100;
        const gridHeight = archiveGrid.offsetHeight || window.innerHeight - 200;
        
        // ê° ì•„ì´í…œì— ëœë¤ ìœ„ì¹˜ ì ìš© ë° ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ì´ˆê¸°í™”
        const archiveItems = archiveGrid.querySelectorAll('.archive-item');
        const items = []; // ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ìš© ì•„ì´í…œ ë°°ì—´
        
        const padding = 50;
        
        archiveItems.forEach((itemEl, index) => {
          const maxX = Math.max(0, gridWidth - itemSize - padding);
          const maxY = Math.max(0, gridHeight - itemSize - padding);
          
          // ëœë¤ ìœ„ì¹˜ ìƒì„±
          const randomX = padding + Math.random() * maxX;
          const randomY = padding + Math.random() * maxY;
          
          // ëœë¤ íšŒì „ ê°ë„ (-30ë„ ~ +30ë„) - ë” í° ë²”ìœ„
          const randomRotate = (Math.random() - 0.5) * 60;
          
          // ì• ë‹ˆë©”ì´ì…˜ ì¤‘ ì¶”ê°€ íšŒì „ ë³€ë™ëŸ‰ (-20ë„ ~ +20ë„)
          const rotateDelta = (Math.random() - 0.5) * 40;
          
          // ëœë¤ ì• ë‹ˆë©”ì´ì…˜ ë”œë ˆì´ (0~6ì´ˆ) - ë” ê¸´ ë”œë ˆì´
          const animationDelay = Math.random() * 6;
          
          // ëœë¤ ì• ë‹ˆë©”ì´ì…˜ ì§€ì† ì‹œê°„ (6~12ì´ˆ) - ë” ê¸´ ì§€ì† ì‹œê°„
          const animationDuration = 6 + Math.random() * 6;
          
          // CSS ë³€ìˆ˜ë¡œ rotate ì €ì¥ (ì• ë‹ˆë©”ì´ì…˜ì—ì„œ ì‚¬ìš©)
          itemEl.style.setProperty('--rotate', `${randomRotate}deg`);
          itemEl.style.setProperty('--rotate-delta', `${rotateDelta}deg`);
          itemEl.style.animationDelay = `${animationDelay}s`;
          itemEl.style.animationDuration = `${animationDuration}s`;
          
          // ì´ˆê¸° ìœ„ì¹˜ë¥¼ transformìœ¼ë¡œ ì„¤ì • (left/top ëŒ€ì‹ )
          itemEl.style.transform = `translate3d(${randomX}px, ${randomY}px, 0) rotate(${randomRotate}deg)`;
          itemEl.style.left = '0';
          itemEl.style.top = '0';
          
          // ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ì´ˆê¸°í™”
          const itemData = {
            element: itemEl,
            x: randomX,
            y: randomY,
            rotate: randomRotate,
            vx: (Math.random() - 0.5) * 0.2, // ì´ˆê¸° ì†ë„ ì¤„ì„ (0.8 â†’ 0.2)
            vy: (Math.random() - 0.5) * 0.2,
            radius: itemSize / 2,
            bounceTime: 0, // íŠ•ê¹€ íš¨ê³¼ ì§€ì† ì‹œê°„
            bounceForce: { x: 0, y: 0 }, // íŠ•ê¹€ í˜
            isHovered: false // hover ìƒíƒœ
          };
          
          // hover ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          itemEl.addEventListener('mouseenter', () => {
            itemData.isHovered = true;
          });
          itemEl.addEventListener('mouseleave', () => {
            itemData.isHovered = false;
          });
          
          items.push(itemData);
        });
        
        // ì˜¤ë²„ë ˆì´ ë¼ì¸ ìë™ ì „í™˜ ì‹œì‘ (í˜„ì¬ í¬ê¸° ì •ë³´ ì „ë‹¬)
        startOverlayRotation(archiveItems, sortedData, maxImgSize);
        
        // ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
        if (items.length > 0) {
          console.log(`ğŸš€ ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘: ${items.length}ê°œ ì•„ì´í…œ`);
          startPhysicsSimulation(items, gridWidth, gridHeight, itemSize);
        } else {
          console.warn('âš ï¸ ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜í•  ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.');
        }
      }, 200); // ì•½ê°„ ë” ëŠ¦ê²Œ ì‹œì‘ (DOM ë Œë”ë§ ì™„ë£Œ ëŒ€ê¸°)
    }
    
    // ë¹ˆ ìƒíƒœ í‘œì‹œ
    function showEmptyState() {
      document.getElementById('archiveGrid').style.display = 'none';
      document.getElementById('emptyState').style.display = 'block';
    }
    
    // ìŠ¤í…Œì´ì§€ ì •ë³´ ìƒì„±
    function generateStageInfo(selections, timestamp) {
      // ì •í™•í•œ ì´ë‹ˆì…œ ë§¤í•‘ (app.jsì˜ ì‹¤ì œ ì €ì¥ í‚¤ê°’ ì‚¬ìš©)
      const initialsMap = {
        // Place (ì˜ì–´ ì²« ê¸€ì)
        'lawn': 'L',      // Lawn
        'forest': 'F',    // Forest
        'valley': 'V',    // Valley
        'sea': 'S',       // Sea
        // Mood (ì˜ì–´ ì²« ê¸€ì)
        'baroque': 'B',           // Baroque
        'romantic': 'R',          // Romanticism
        'impression': 'I',        // Impressionism
        'post': 'P',              // Postmodernism
        // Flow (ì˜ì–´ ì²« ê¸€ì)
        'recline': 'R',   // Recline
        'lounge': 'L',    // Lounge
        'settle': 'S',    // Settle
        'wander': 'W',    // Wander
        // Extras (ì˜ì–´ ì²« ê¸€ì)
        'dialogue': 'D',        // Dialogue
        'refresh': 'R',         // Refreshment
        'play': 'P',            // Playground
        'fire': 'F'             // Fireworks
      };
      
      const initials = [
        initialsMap[selections.place] || 'X',
        initialsMap[selections.mood] || 'X',
        initialsMap[selections.flow] || 'X',
        initialsMap[selections.extras] || 'X'
      ].join('');
      
      const stageName = `${initials} Stage`;
      
      // ë‚ ì§œ/ì‹œê°„ í¬ë§·
      const date = new Date(timestamp);
      const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '/');
      const timeStr = date.toTimeString().slice(0, 5);
      
      return {
        stageName: stageName,
        dateTime: `${dateStr}<br>${timeStr}`
      };
    }
    
    // ì˜¤ë²„ë ˆì´ ë¼ì¸ê³¼ ì„ íƒì§€ ì •ë³´ ì¶”ê°€
    function addOverlayToItem(itemElement, itemData, overlayLineNum, maxImgSize) {
      // ì˜¤ë²„ë ˆì´ ë¼ì¸ ì„ íƒ (1~5)
      const overlayLinePath = `archive/overlay_line${overlayLineNum}.svg`;
      
      // ì„ íƒì§€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const selections = itemData.selections || {};
      
      // í•œê¸€ ë ˆì´ë¸” ë§¤í•‘
      const placeLabels = {
        'lawn': 'ë“¤íŒ',
        'forest': 'ìˆ²ì†',
        'valley': 'ê³„ê³¡',
        'sea': 'ë°”ë‹·ê°€'
      };
      
      const moodLabels = {
        'baroque': 'ì •êµí•œ ì„ ìœ¨',
        'romanticism': 'ê°•ë ¬í•œ ê°ì •',
        'impressionism': 'ëª½í™˜ì  ìŒìƒ‰',
        'postmodernism': 'ììœ ë¡œìš´ í˜•ì‹'
      };
      
      const flowLabels = {
        'recline': 'í¸ì•ˆíˆ ëˆ„ì›Œ',
        'lounge': 'ììœ ë¡­ê²Œ ì•‰ì•„',
        'settle': 'ì¢Œì„ì—ì„œ ëª°ì…í•´',
        'wander': 'ê°€ë³ê²Œ ëŒì•„ë‹¤ë‹ˆë©°'
      };
      
      const extrasLabels = {
        'dialogue': 'ì—°ì£¼ìì™€ ì†Œí†µìœ¼ë¡œ',
        'refreshment': 'ë‹¤ê³¼ ì‹œê°„ìœ¼ë¡œ',
        'playground': 'ìŒì•… í”Œë ˆì´ì¡´ìœ¼ë¡œ',
        'fireworks': 'ë¶ˆë¹› ë§ˆë‹¹ìœ¼ë¡œ'
      };
      
      // ì•…ê¸° í•œê¸€ëª… ìœ ì§€ (ì˜ì–´ ì•½ì ì‚¬ìš© ì•ˆ í•¨)
      const instrumentKoreanLabels = {
        'ë°”ì´ì˜¬ë¦°': 'ë°”ì´ì˜¬ë¦°',
        'ë¹„ì˜¬ë¼': 'ë¹„ì˜¬ë¼',
        'ì²¼ë¡œ': 'ì²¼ë¡œ',
        'íŠ¸ëŸ¼ë³¸': 'íŠ¸ëŸ¼ë³¸',
        'íŠ¸ëŸ¼í«': 'íŠ¸ëŸ¼í«',
        'í˜¸ë¥¸': 'í˜¸ë¥¸',
        'í”Œë£»': 'í”Œë£»',
        'í´ë¼ë¦¬ë„·': 'í´ë¼ë¦¬ë„·',
        'ì½˜íŠ¸ë¼ë² ì´ìŠ¤': 'ì½˜íŠ¸ë¼ë² ì´ìŠ¤'
      };
      
      // ì„ íƒì§€ í…ìŠ¤íŠ¸ ìƒì„± (í•´ë‹¹ ê·¸ë˜í”½ì„ êµ¬ì„±í•˜ëŠ” ì„ íƒì§€ë§Œ í‘œì‹œ - ì˜¤ë¡œì§€ í•œê¸€ë§Œ)
      const selectionParts = [];
      
      if (selections.place) {
        const placeText = placeLabels[selections.place];
        if (placeText) selectionParts.push(placeText);
      }
      if (selections.mood) {
        const moodText = moodLabels[selections.mood];
        if (moodText) selectionParts.push(moodText);
      }
      if (selections.flow) {
        const flowText = flowLabels[selections.flow];
        if (flowText) selectionParts.push(flowText);
      }
      if (selections.extras) {
        const extrasText = extrasLabels[selections.extras];
        if (extrasText) selectionParts.push(extrasText);
      }
      if (selections.instruments && Array.isArray(selections.instruments) && selections.instruments.length > 0) {
        const instrumentText = selections.instruments.slice(0, 3)
          .map(inst => instrumentKoreanLabels[inst] || inst)
          .join(' ');
        if (instrumentText) {
          selectionParts.push(instrumentText);
        }
      }
      
      // ê° ì„ íƒì§€ë¥¼ spanìœ¼ë¡œ ê°ì‹¸ì„œ ì¤„ë„˜ê¹€ ë°©ì§€
      const selectionText = selectionParts.length > 0 
        ? selectionParts.map(part => `<span class="selection-item">${part}</span>`).join('') 
        : '';
      
      // í°íŠ¸ í¬ê¸° ë™ì  ê³„ì‚° (ê·¸ë˜í”½ í¬ê¸°ì— ë¹„ë¡€í•˜ë˜ í…ìŠ¤íŠ¸ê°€ ê³¼ë„í•˜ê²Œ ì»¤ì§€ì§€ ì•Šë„ë¡)
      // 250pxë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ë˜, ê·¸ë˜í”½ í¬ê¸° ë³€í™”ì— í…ìŠ¤íŠ¸ëŠ” ë” ì‘ê²Œ ë°˜ì‘ (0.6ë°°)
      const baseFontSize = 250; // ê¸°ì¤€ ê·¸ë˜í”½ í¬ê¸°
      const fontSizeRatio = 0.6; // í…ìŠ¤íŠ¸ ë³€í™” ë¹„ìœ¨ (ê·¸ë˜í”½ë³´ë‹¤ ì‘ê²Œ)
      const normalizedScale = 1 + (maxImgSize - baseFontSize) / baseFontSize * fontSizeRatio;
      // ì‹¤ì œ í”½ì…€ í¬ê¸°ë¡œ ê³„ì‚°
      const baseFontSizePx = window.innerWidth * 0.007; // 0.7vwë¥¼ í”½ì…€ë¡œ ë³€í™˜
      const overlayFontSizePx = baseFontSizePx * normalizedScale * 0.9;
      const overlayFontSize = `${overlayFontSizePx}px`;
      
      // ì˜¤ë²„ë ˆì´ HTML ìƒì„± (ì„ íƒì§€ê°€ ìˆì„ ë•Œë§Œ)
      let overlayHTML = '';
      if (selectionText) {
        overlayHTML = `
          <div class="overlay-line-wrapper">
            <img src="${overlayLinePath}" alt="ì˜¤ë²„ë ˆì´ ë¼ì¸" class="overlay-line">
            <div class="overlay-text" style="font-size: ${overlayFontSize};">
              ${selectionText}
            </div>
          </div>
        `;
      }
      
      // ì˜¤ë²„ë ˆì´ ì¶”ê°€
      itemElement.insertAdjacentHTML('beforeend', overlayHTML);
    }
    
    // ì˜¤ë²„ë ˆì´ ìë™ ì „í™˜
    let overlayRotationInterval = null;
    
    function startOverlayRotation(archiveItems, sortedData, maxImgSize) {
      // ê¸°ì¡´ ì¸í„°ë²Œ ì •ë¦¬
      if (overlayRotationInterval) {
        clearInterval(overlayRotationInterval);
      }
      
      if (archiveItems.length === 0 || sortedData.length === 0) {
        return;
      }
      
      // ìµœì´ˆ ì˜¤ë²„ë ˆì´ ì¶”ê°€
      rotateOverlay(archiveItems, sortedData, maxImgSize);
      
      // 4ì´ˆë§ˆë‹¤ ì˜¤ë²„ë ˆì´ ì „í™˜
      overlayRotationInterval = setInterval(() => {
        rotateOverlay(archiveItems, sortedData, maxImgSize);
      }, 4000);
    }
    
    function rotateOverlay(archiveItems, sortedData, maxImgSize) {
      // ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ì œê±°
      archiveItems.forEach(item => {
        const existingOverlay = item.querySelector('.overlay-line-wrapper');
        if (existingOverlay) {
          existingOverlay.remove();
        }
      });
      
      // ìƒˆë¡œìš´ ëœë¤ ì˜¤ë²„ë ˆì´ ì¶”ê°€
      const randomItemIndex = Math.floor(Math.random() * archiveItems.length);
      const randomItem = archiveItems[randomItemIndex];
      const correspondingData = sortedData[randomItemIndex];
      const randomOverlayLine = Math.floor(Math.random() * 5) + 1;
      
      if (randomItem && correspondingData) {
        addOverlayToItem(randomItem, correspondingData, randomOverlayLine, maxImgSize);
      }
    }
    
    // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ ì¸í„°ë²Œ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
      if (overlayRotationInterval) {
        clearInterval(overlayRotationInterval);
      }
    });
    
    // ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ (ì¶©ëŒ ê°ì§€ ë° íŠ•ê¹€ íš¨ê³¼)
    let animationFrameId = null;
    let physicsRunning = false;
    
    function startPhysicsSimulation(items, gridWidth, gridHeight, itemSize) {
      if (physicsRunning) return;
      physicsRunning = true;
      
      const padding = 50;
      const minX = padding;
      const minY = padding;
      const maxX = gridWidth - itemSize - padding;
      const maxY = gridHeight - itemSize - padding;
      
      function updatePhysics() {
        // ê° ì•„ì´í…œ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        const time = Date.now() / 1000; // ì‹œê°„ì„ forEach ë°–ì—ì„œ ê³„ì‚°
        
        items.forEach((item, i) => {
          // íŠ•ê¹€ í˜ ê°ì†Œ (ëŒí•‘)
          if (item.bounceTime > 0) {
            item.vx += item.bounceForce.x * 0.1;
            item.vy += item.bounceForce.y * 0.1;
            item.bounceTime -= 1;
            
            if (item.bounceTime <= 0) {
              item.bounceForce = { x: 0, y: 0 };
            }
          }
          
          // ê¸°ë³¸ ë– ë‹¤ë‹ˆëŠ” ì›€ì§ì„ ëŒ€í­ ì¤„ì„ (ì¶©ëŒ ì‹œ íŠ•ê¹€ ìœ„ì£¼ë¡œ)
          // item.vx += (Math.random() - 0.5) * 0.1; // ì œê±°
          // item.vy += (Math.random() - 0.5) * 0.1; // ì œê±°
          
          // ì£¼ê¸°ì ì¸ ë– ë‹¤ë‹ˆëŠ” ì›€ì§ì„ ì¤„ì„
          const phase = (time + i * 0.5) * 0.3; // 0.5 â†’ 0.3 (ë” ëŠë¦¬ê²Œ)
          item.vx += Math.sin(phase) * 0.02; // 0.08 â†’ 0.02 (ë§¤ìš° ì‘ê²Œ)
          item.vy += Math.cos(phase * 1.3) * 0.02;
          
          // ì¶”ê°€ í”Œë¡œíŒ… íš¨ê³¼ ì œê±° (ì¶©ëŒ ìœ„ì£¼ë¡œ)
          // const floatPhase = (time + i * 0.3) * 0.3;
          // item.vx += Math.sin(floatPhase * 2) * 0.06;
          // item.vy += Math.cos(floatPhase * 1.7) * 0.06;
          
          // ì†ë„ ì œí•œ ì¤„ì„
          const maxSpeed = 0.5; // 1.5 â†’ 0.5 (ë” ëŠë¦¬ê²Œ)
          item.vx = Math.max(-maxSpeed, Math.min(maxSpeed, item.vx));
          item.vy = Math.max(-maxSpeed, Math.min(maxSpeed, item.vy));
          
          // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
          item.x += item.vx;
          item.y += item.vy;
          
          // ê²½ê³„ ì¶©ëŒ (ë²½ì— íŠ•ê¹€)
          if (item.x < minX) {
            item.x = minX;
            item.vx *= -0.8; // ë°˜ë°œ ê³„ìˆ˜
            item.vy *= 0.95; // ë§ˆì°°
          } else if (item.x > maxX) {
            item.x = maxX;
            item.vx *= -0.8;
            item.vy *= 0.95;
          }
          
          if (item.y < minY) {
            item.y = minY;
            item.vy *= -0.8;
            item.vx *= 0.95;
          } else if (item.y > maxY) {
            item.y = maxY;
            item.vy *= -0.8;
            item.vx *= 0.95;
          }
          
          // ë‹¤ë¥¸ ì•„ì´í…œê³¼ì˜ ì¶©ëŒ ê°ì§€
          for (let j = i + 1; j < items.length; j++) {
            const other = items[j];
            const dx = item.x - other.x;
            const dy = item.y - other.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const minDistance = item.radius + other.radius;
            
            if (distance < minDistance && distance > 0) {
              // ì¶©ëŒ ë°œìƒ!
              const angle = Math.atan2(dy, dx);
              const overlap = minDistance - distance;
              
              // ì•„ì´í…œì„ ë¶„ë¦¬
              const separationX = Math.cos(angle) * overlap * 0.5;
              const separationY = Math.sin(angle) * overlap * 0.5;
              item.x += separationX;
              item.y += separationY;
              other.x -= separationX;
              other.y -= separationY;
              
              // ë°˜ë°œ ì†ë„ ê³„ì‚°
              const relativeVx = item.vx - other.vx;
              const relativeVy = item.vy - other.vy;
              const relativeSpeed = Math.cos(angle) * relativeVx + Math.sin(angle) * relativeVy;
              
              if (relativeSpeed > 0) {
                // íŠ•ê¹€ í˜ ê³„ì‚° (ì ë‹¹í•˜ê²Œ)
                const bounceStrength = Math.min(relativeSpeed * 15, 10); // 20â†’15, 15â†’10ìœ¼ë¡œ ì¤„ì„
                const bounceX = Math.cos(angle) * bounceStrength;
                const bounceY = Math.sin(angle) * bounceStrength;
                
                // íŠ•ê¹€ íš¨ê³¼ ì ìš© (ì¶©ëŒ ì‹œ íŠ•ê¹€ì€ ìœ ì§€)
                item.bounceForce = { x: bounceX, y: bounceY };
                item.bounceTime = 60; // 90 â†’ 60 (íŠ•ê¹€ ì§€ì† ì‹œê°„ ì¤„ì„)
                item.vx += bounceX * 0.7; // 0.8 â†’ 0.7
                item.vy += bounceY * 0.7;
                // íŠ•ê¹€ ì‹œ íšŒì „ë„ ì•½ê°„ ì¤„ì„
                item.rotate += (Math.random() - 0.5) * 15; // 20 â†’ 15
                
                other.bounceForce = { x: -bounceX, y: -bounceY };
                other.bounceTime = 60;
                other.vx -= bounceX * 0.7;
                other.vy -= bounceY * 0.7;
                other.rotate += (Math.random() - 0.5) * 15;
              }
            }
          }
          
          // CSS transform ì—…ë°ì´íŠ¸ (ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ + íšŒì „)
          // translateZ(0)ì„ ì‚¬ìš©í•˜ì—¬ GPU ê°€ì† í™œìš©
          if (item.isHovered) {
            // hover ì‹œ scale ì ìš© ë° ì•½ê°„ ìœ„ë¡œ
            item.element.style.transform = `translate3d(${item.x}px, ${item.y - 15}px, 0) rotate(${item.rotate}deg) scale(1.15)`;
          } else {
            item.element.style.transform = `translate3d(${item.x}px, ${item.y}px, 0) rotate(${item.rotate}deg)`;
          }
          item.element.style.willChange = 'transform';
          
          // íšŒì „ë„ ì‚´ì§ ë³€ë™ (íŠ•ê¹€ ì‹œ ì¶”ê°€ íšŒì „)
          if (item.bounceTime > 0) {
            item.rotate += (Math.random() - 0.5) * 2;
          }
          
          // ì†ë„ ê°ì†Œ (ë§ˆì°°) - ë” í¬ê²Œ (ë” ë¹¨ë¦¬ ì •ì§€)
          item.vx *= 0.99; // 0.998 â†’ 0.99 (ë” ë¹ ë¥´ê²Œ ê°ì†Œ)
          item.vy *= 0.99;
          
          // íšŒì „ë„ ê±°ì˜ ë³€ë™í•˜ì§€ ì•ŠìŒ (ì¶©ëŒ ì‹œì—ë§Œ íšŒì „)
          // item.rotate += (Math.random() - 0.5) * 0.3; // ì œê±°
        });
        
        animationFrameId = requestAnimationFrame(updatePhysics);
      }
      
      console.log('âœ… ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ ë£¨í”„ ì‹œì‘');
      updatePhysics();
    }
    
    // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ ì• ë‹ˆë©”ì´ì…˜ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
      }
    });
    
    // í‹°ì¼“ ìƒì„¸ ë³´ê¸° (ë‚˜ì¤‘ì— êµ¬í˜„ ê°€ëŠ¥)
    function viewTicket(ticketId) {
      console.log('í‹°ì¼“ ë³´ê¸°:', ticketId);
      // TODO: í‹°ì¼“ ìƒì„¸ ëª¨ë‹¬ ë˜ëŠ” í˜ì´ì§€ êµ¬í˜„
    }
    
    // ì•„ì¹´ì´ë¸Œ ì „ì²´ ì‚­ì œ
    function clearArchive() {
      if (confirm('ì •ë§ë¡œ ëª¨ë“  ì•„ì¹´ì´ë¸Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        localStorage.removeItem(ARCHIVE_KEY);
        localStorage.removeItem('portato_selections');
        localStorage.removeItem('portatoCurrentStep');
        console.log('ğŸ§¹ ëª¨ë“  ì•„ì¹´ì´ë¸Œ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ');
        loadArchive();
        alert('ì•„ì¹´ì´ë¸Œê°€ ë¹„ì›Œì¡ŒìŠµë‹ˆë‹¤.');
      }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', function() {
      loadArchive();
    });
  </script>
</body>
</html>
