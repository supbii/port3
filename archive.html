<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PORTATO â€” ì•„ì¹´ì´ë¸Œ</title>
  <link rel="preconnect" href="https://bks0c7yrb0.execute-api.ap-northeast-2.amazonaws.com">
  <link rel="stylesheet" href="https://bks0c7yrb0.execute-api.ap-northeast-2.amazonaws.com/v1/api/css/drop_fontstream_css/?sid=gAAAAABkPXHo4qvpc1sn4CfuJL52Upc7AT8TVi8zpqX6aZtd3bQar6UDsPKea-00OVjtEVNfrYxuRy0KwyP7evvOGmFn-UJE3J2fgwZrrKxTO78AFSLAqGsk2yWcjZ17eIWeK8W_hEM0WwmzRDJ8PY0OKk9vf2d1gDahwuKJRCRKWS-LyUCxQDP7meUclfmM9WUoaP-N0gjIL5lyx-sFjuMGMGstTkeslXuA25WmkTdqzwQN4zkCffosmIAvef50EDHxTj2cl6OL" charset="utf-8" referrerpolicy="origin">
  <link rel="stylesheet" href="styles.css">
  <style>
    
    :root { 
      --ink: #ebfeb3; 
      --bg: #3C6C71; 
      --accent: #2d5a5f;
      --font-main: 'Sandoll SuPil', sans-serif;
      --font-sub: 'Sandoll Gwanghwamun', serif;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: var(--font-main);
      background: var(--bg);
      color: var(--ink);
      overflow-x: visible; /* í—¤ë”ê°€ ì˜ë¦¬ì§€ ì•Šë„ë¡ visibleë¡œ ì„¤ì • */
      overflow-y: auto;
      min-width: 0;
    }
    
    /* í—¤ë” ì»¨í…Œì´ë„ˆ */
    .header-container {
      position: fixed;
      top: 2vh; /* ì—¬ë°± ì¤„ì„ */
      left: 2vw; /* ì¢Œìƒë‹¨ìœ¼ë¡œ ë” ì´ë™ */
      z-index: 2000;
      pointer-events: none;
      padding: 0; /* ì—¬ë°± ì œê±° */
      margin: 0;
      box-sizing: content-box;
      overflow: visible !important;
      width: auto;
      max-width: none;
      min-width: max-content;
      background: transparent;
    }
    
    /* í—¤ë” */
    .header {
      position: relative;
      display: inline-block;
      white-space: nowrap;
      overflow: visible !important;
      width: auto !important;
      max-width: none !important;
      min-width: max-content;
      box-sizing: content-box;
      padding: 0;
      margin: 0;
    }
    
    .header h1 {
      font-family: 'Sandoll SuPil', sans-serif;
      font-size: clamp(2.5vw, 4vmin, 3.5vw);
      font-weight: 900; /* ê°€ì¥ ë³¼ë“œ */
      margin: 0 !important;
      padding: 0 !important;
      color: #77B975 !important;
      letter-spacing: 0.05em;
      white-space: nowrap !important;
      overflow: visible !important;
      text-overflow: clip !important;
      width: auto !important;
      max-width: none !important;
      min-width: max-content !important;
      display: inline-block !important;
      line-height: 1.2;
      visibility: visible !important;
      opacity: 1 !important;
      transform: none !important;
      word-wrap: normal !important;
      word-break: normal !important;
      hyphens: none !important;
      text-align: left !important;
    }
    
    .bg {
      position: fixed;
      inset: 0;
      background: url("archive/background.png") center/cover no-repeat;
      z-index: 0;
      pointer-events: none;
    }
    
    #bgStack {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
    }
    
    #bgStack #bgLayer {
      position: absolute;
      inset: 0;
      background: url("archive/background.png") center/cover no-repeat;
    }
    
    #bgStack #screenOverlay {
      position: absolute;
      inset: 0;
      background: transparent;
    }
    
    .ui-root {
      position: relative;
      z-index: 10;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2vw;
      box-sizing: border-box;
      overflow: visible; /* í—¤ë”ê°€ ë³´ì´ë„ë¡ */
      max-width: none;
      width: 100%;
    }
    
    .archive-stats {
      position: fixed;
      top: 3vh;
      right: 3vw;
      z-index: 2000;
      pointer-events: none;
      text-align: right;
    }
    
    .archive-stats .stat-line {
      font-family: 'Sandoll SuPil', sans-serif;
      font-size: clamp(1.2vw, 2vmin, 1.8vw);
      font-weight: 600;
      color: #77B975;
      margin: 0;
      margin-bottom: 0.5vh;
      line-height: 1.4;
      white-space: nowrap;
    }
    
    .archive-stats .stat-number {
      font-weight: 900;
      font-size: 1.1em;
    }
    
    .archive-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      min-height: 100vh;
      overflow: visible; /* í—¤ë”ê°€ ë³´ì´ë„ë¡ visibleë¡œ ë³€ê²½ */
      padding: 0;
    }
    
    .archive-grid {
      position: relative;
      width: 100%;
      min-height: calc(100vh - 200px);
      margin-bottom: 3vw;
      /* ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ë†’ì´ ì œí•œ ì œê±°, ë‚´ìš©ì— ë§ê²Œ ìë™ í™•ì¥ */
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    .archive-item {
      position: absolute;
      background: transparent;
      border: none;
      border-radius: 15px;
      padding: 0;
      backdrop-filter: none;
      box-shadow: none;
      cursor: pointer;
      /* CSS ì• ë‹ˆë©”ì´ì…˜ì€ ë¹„í™œì„±í™” (ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ì´ ì²˜ë¦¬) */
      /* animation: float 8s ease-in-out infinite; */
      transition: transform 0.1s linear, z-index 0.3s ease;
      --rotate: 0deg; /* ê¸°ë³¸ rotate ê°’ */
      --rotate-delta: 0deg; /* ì• ë‹ˆë©”ì´ì…˜ ì¤‘ íšŒì „ ë³€ë™ëŸ‰ */
      will-change: transform;
    }
    
    .archive-item:hover {
      /* hover ì‹œ ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ ì¼ì‹œ ì •ì§€ */
      z-index: 100;
      filter: drop-shadow(0 10px 20px rgba(235, 254, 179, 0.3));
    }
    
    /* ìƒˆë¡œìš´ ì•„ì´í…œ ë°˜ì§ì„ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes newItemGlow {
      0%, 100% {
        filter: drop-shadow(0 0 20px rgba(235, 254, 179, 1)) drop-shadow(0 0 40px rgba(235, 254, 179, 0.9)) drop-shadow(0 0 60px rgba(235, 254, 179, 0.7)) drop-shadow(0 0 80px rgba(235, 254, 179, 0.5));
        opacity: 1;
      }
      50% {
        filter: drop-shadow(0 0 40px rgba(235, 254, 179, 1)) drop-shadow(0 0 80px rgba(235, 254, 179, 1)) drop-shadow(0 0 120px rgba(235, 254, 179, 0.9)) drop-shadow(0 0 160px rgba(235, 254, 179, 0.7)) drop-shadow(0 0 200px rgba(235, 254, 179, 0.5));
        opacity: 1;
      }
    }
    
    .archive-item.new-item {
      animation: newItemGlow 1.2s ease-in-out infinite;
      z-index: 200;
      /* ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ì˜ transformê³¼ ì¶©ëŒí•˜ì§€ ì•Šë„ë¡ transformì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ */
    }
    
    /* 10ì´ˆ í›„ ì• ë‹ˆë©”ì´ì…˜ í˜ì´ë“œì•„ì›ƒ */
    @keyframes fadeOutGlow {
      from {
        filter: drop-shadow(0 0 20px rgba(235, 254, 179, 1)) drop-shadow(0 0 40px rgba(235, 254, 179, 0.9)) drop-shadow(0 0 60px rgba(235, 254, 179, 0.7));
      }
      to {
        filter: drop-shadow(0 10px 20px rgba(235, 254, 179, 0.3));
        animation: none;
      }
    }
    
    .archive-item.new-item.fade-out {
      animation: fadeOutGlow 1s ease-out forwards;
    }
    
    /* ì¼ê´„ ì‚­ì œ ë²„íŠ¼ */
    .clear-archive-btn {
      display: none; /* ë²„íŠ¼ ìˆ¨ê¹€ */
      position: fixed;
      bottom: 8vh;
      right: 3vw;
      background: rgba(60, 108, 113, 0.8);
      border: 2px solid rgba(235, 254, 179, 0.6);
      color: var(--ink);
      padding: 1vw 2vw;
      border-radius: 25px;
      font-size: clamp(0.9vw, 1.6vmin, 1.3vw);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 1000;
      font-family: var(--font-main);
    }
    
    .clear-archive-btn:hover {
      background: rgba(60, 108, 113, 0.95);
      border-color: rgba(235, 254, 179, 0.9);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    /* ì˜¤ë²„ë ˆì´ ë¼ì¸ ìŠ¤íƒ€ì¼ */
    .overlay-line-wrapper {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }
    
    .overlay-line {
      width: 100%;
      height: 100%;
      object-fit: contain;
      opacity: 0.9;
    }
    
    .overlay-text {
      position: absolute;
      left: calc(100% + 20px);
      top: 50%;
      transform: translateY(-50%);
      background: rgba(254, 255, 238, 0.85);
      color: #609BA1;
      padding: 0;
      border-radius: 0;
      font-family: 'Sandoll SuPil', sans-serif;
      font-size: clamp(0.8vw, 1.2vmin, 1.8vw);
      font-weight: 900;
      line-height: 1.4;
      z-index: 10001;
      pointer-events: none;
      box-shadow: none;
      border: none;
      max-width: none;
      white-space: normal;
    }
    
    .overlay-text .selection-item {
      display: block;
      white-space: nowrap;
      margin-bottom: 0.1vw;
    }
    
    .overlay-text .selection-item:last-child {
      margin-bottom: 0;
    }
    
    .overlay-text .selection-title {
      font-weight: 900;
      font-size: 1.1em;
      margin-bottom: 0.3vw;
      display: block;
    }
    
    /* í‹°ì¼“ ì •ë³´ ìŠ¤íƒ€ì¼ */
    .archive-stage-info {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      /* bottomì€ JavaScriptì—ì„œ ê·¸ë˜í”½ í¬ê¸°ì— ë¹„ë¡€í•˜ì—¬ ë™ì ìœ¼ë¡œ ì„¤ì • */
      background: transparent;
      color: #609BA1;
      font-family: 'Sandoll SuPil', sans-serif;
      /* font-sizeëŠ” JavaScriptì—ì„œ ê·¸ë˜í”½ í¬ê¸°ì— ë¹„ë¡€í•˜ì—¬ ë™ì ìœ¼ë¡œ ì„¤ì • */
      font-weight: 600;
      line-height: 1.2;
      white-space: normal;
      z-index: 51;
      pointer-events: none;
      max-width: none;
      text-align: center;
    }
    
    .archive-stage-info .stage-name {
      display: block;
      margin-bottom: 0.2vw;
      font-weight: 600;
    }
    
    .archive-stage-info .stage-datetime {
      display: block;
      font-weight: 600;
      line-height: 1.1;
    }
    
    .overlay-text .selection-details {
      font-size: 0.95em;
      opacity: 0.95;
    }
    
    @keyframes float {
      0%, 100% {
        transform: translateY(0px) translateX(0px) rotate(calc(var(--rotate, 0deg) + var(--rotate-delta, 0deg)));
      }
      12.5% {
        transform: translateY(-40px) translateX(25px) rotate(calc(var(--rotate, 0deg) + var(--rotate-delta, 0deg) + 8deg));
      }
      25% {
        transform: translateY(-30px) translateX(-20px) rotate(calc(var(--rotate, 0deg) + var(--rotate-delta, 0deg) + 15deg));
      }
      37.5% {
        transform: translateY(-50px) translateX(15px) rotate(calc(var(--rotate, 0deg) + var(--rotate-delta, 0deg) + 10deg));
      }
      50% {
        transform: translateY(-20px) translateX(-30px) rotate(calc(var(--rotate, 0deg) + var(--rotate-delta, 0deg) - 12deg));
      }
      62.5% {
        transform: translateY(-35px) translateX(20px) rotate(calc(var(--rotate, 0deg) + var(--rotate-delta, 0deg) - 8deg));
      }
      75% {
        transform: translateY(-25px) translateX(-15px) rotate(calc(var(--rotate, 0deg) + var(--rotate-delta, 0deg) + 5deg));
      }
      87.5% {
        transform: translateY(-45px) translateX(10px) rotate(calc(var(--rotate, 0deg) + var(--rotate-delta, 0deg) - 5deg));
      }
    }
    
    .ticket-image {
      width: 100%;
      height: auto;
      border-radius: 10px;
      margin-bottom: 1vw;
      background: transparent;
    }
    
    /* ì•„ì¹´ì´ë¸Œ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ ê°•ì œ ì œê±° */
    .ticket-container img {
      border: 0 !important;
      outline: 0 !important;
      background: transparent !important;
      box-shadow: none !important;
      filter: none !important;
    }
    
    .ticket-info {
      text-align: center;
      /* margin-topì€ JavaScriptì—ì„œ ê·¸ë˜í”½ í¬ê¸°ì— ë¹„ë¡€í•˜ì—¬ ë™ì ìœ¼ë¡œ ì„¤ì • */
    }
    
    .ticket-date {
      font-size: clamp(0.8vw, 1.4vmin, 1.2vw);
      color: rgba(235,254,179,0.7);
      margin-bottom: 0.5vw;
    }
    
    .ticket-id {
      font-size: clamp(0.7vw, 1.2vmin, 1vw);
      color: rgba(235,254,179,0.5);
      font-family: monospace;
    }
    
    .empty-state {
      text-align: center;
      padding: 4vw;
      color: rgba(235,254,179,0.6);
    }
    
    .empty-state h3 {
      font-size: clamp(1.8vw, 3vmin, 2.2vw);
      margin-bottom: 1vw;
      color: var(--ink);
    }
    
    .empty-state p {
      font-size: clamp(1vw, 1.8vmin, 1.5vw);
      margin-bottom: 2vw;
    }
    
    .btn {
      background: linear-gradient(135deg, var(--accent) 0%, #1e4a4d 100%);
      border: 2px solid var(--ink);
      color: var(--ink);
      padding: 1vw 2vw;
      border-radius: 25px;
      font-size: clamp(1vw, 1.8vmin, 1.5vw);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn:hover {
      background: linear-gradient(135deg, var(--ink) 0%, #d4f4a8 100%);
      color: var(--bg);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .footer {
      position: fixed;
      bottom: 2vh;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1vw;
      opacity: 0.9;
      z-index: 21;
      color: var(--ink);
      text-align: center;
    }
    
    
    @media (max-width: 600px) {
      .archive-item {
        max-width: 100px;
        max-height: 100px;
      }
      
    }
  </style>
</head>
<body>
  <!-- ë°°ê²½ -->
  <div id="bgStack" aria-hidden="true">
    <div id="bgLayer"></div>
    <div id="screenOverlay"></div>
  </div>

  <!-- í—¤ë” ì»¨í…Œì´ë„ˆ -->
  <div class="header-container">
    <div class="header">
      <h1>PortATO ì•„ì¹´ì´ë¸Œ   â€”   </h1>
    </div>
  </div>
  
  <!-- í†µê³„ (body ì§í•˜ìœ„ë¡œ ì´ë™) -->
  <div class="archive-stats" id="archiveStats">
    <div class="stat-line">
      ì§€ê¸ˆê¹Œì§€ ìŒ“ì—¬ì˜¨ í¬ë¥´íƒ€í†  ê³µì—°ì˜ ìˆ˜<br>
      <span class="stat-number" id="totalCount">0</span>
    </div>
    <div class="stat-line">
      ì˜¤ëŠ˜ ìŒ“ì¸ í¬ë¥´íƒ€í†  ê³µì—°ì˜ ìˆ˜<br>
      <span class="stat-number" id="todayCount">0</span>
    </div>
  </div>

  <div class="ui-root">
    <!-- ì•„ì¹´ì´ë¸Œ ì»¨í…Œì´ë„ˆ -->
    <div class="archive-container">
      <div class="archive-grid" id="archiveGrid">
          <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
      </div>
      
      <!-- ë¹ˆ ìƒíƒœ -->
      <div class="empty-state" id="emptyState" style="display: none;">
        <h3>ì•„ì§ ì €ì¥ëœ í‹°ì¼“ì´ ì—†ìŠµë‹ˆë‹¤</h3>
        <p>ìƒˆë¡œìš´ í‹°ì¼“ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
        <a href="index.html" class="btn">ìƒˆ í‹°ì¼“ ë§Œë“¤ê¸°</a>
      </div>
    </div>
  </div>
  
  <!-- ì¼ê´„ ì‚­ì œ ë²„íŠ¼ -->
  <button class="clear-archive-btn" onclick="clearArchive()">ëª¨ë“  í‹°ì¼“ ì‚­ì œ</button>

  <footer class="footer">
    <small>Â© 2025 PORTATO</small>
  </footer>

  <script>
    const ARCHIVE_KEY = "portato_archive_v1";
    const LAST_VIEWED_KEY = "portato_last_viewed_timestamp";
    
    // ì•„ì¹´ì´ë¸Œ ë°ì´í„° ë¡œë“œ ë° í‘œì‹œ
    function loadArchive() {
      try {
        const archiveData = JSON.parse(localStorage.getItem(ARCHIVE_KEY) || '[]');
        console.log('ğŸ“š ì•„ì¹´ì´ë¸Œ ë°ì´í„°:', archiveData);
        
        // ê° ì•„ì´í…œì˜ ì´ë¯¸ì§€ ìœ„ì¹˜ ì •ë³´ ìƒì„¸ ë¡œê·¸
        archiveData.forEach((item, index) => {
          console.log(`ğŸ“‹ ì•„ì´í…œ ${index + 1}:`, item.id);
          console.log('   - imagePositions:', item.imagePositions);
          if (item.imagePositions) {
            item.imagePositions.forEach((img, imgIndex) => {
              console.log(`   - ì´ë¯¸ì§€ ${imgIndex + 1}:`, img.src, 'ìœ„ì¹˜:', img.left, img.top);
            });
          }
        });
        
        displayArchive(archiveData);
        displayArchiveStats(archiveData);
        
      } catch (error) {
        console.error('âŒ ì•„ì¹´ì´ë¸Œ ë¡œë“œ ì‹¤íŒ¨:', error);
        showEmptyState();
      }
    }
    
    // ì•„ì¹´ì´ë¸Œ í†µê³„ í‘œì‹œ
    function displayArchiveStats(archiveData) {
      const totalCount = archiveData.length;
      
      // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const todayCount = archiveData.filter(item => {
        const itemDate = new Date(item.timestamp);
        itemDate.setHours(0, 0, 0, 0);
        return itemDate.getTime() === today.getTime();
      }).length;
      
      // í†µê³„ ì—…ë°ì´íŠ¸
      const totalCountEl = document.getElementById('totalCount');
      const todayCountEl = document.getElementById('todayCount');
      
      if (totalCountEl) {
        totalCountEl.textContent = totalCount;
      }
      if (todayCountEl) {
        todayCountEl.textContent = todayCount;
      }
      
      console.log(`ğŸ“Š ì•„ì¹´ì´ë¸Œ í†µê³„: ì´ ${totalCount}ê°œ, ì˜¤ëŠ˜ ${todayCount}ê°œ`);
    }
    
    // ì•„ì¹´ì´ë¸Œ í‘œì‹œ
    function displayArchive(archiveData) {
      const archiveGrid = document.getElementById('archiveGrid');
      const emptyState = document.getElementById('emptyState');
      
      if (archiveData.length === 0) {
        archiveGrid.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }
      
      archiveGrid.style.display = 'block';
      emptyState.style.display = 'none';
      
      // ìµœì‹  ìˆœìœ¼ë¡œ ì •ë ¬
      const sortedData = archiveData.sort((a, b) => b.timestamp - a.timestamp);
      
      // í•­ëª© ê°œìˆ˜ì™€ í™”ë©´ ë¹„ìœ¨ì— ë”°ë¥¸ í¬ê¸° ì¡°ì • (í™”ë©´ ë¹„ë¡€ ë‹¨ìœ„ ì‚¬ìš©)
      const itemCount = sortedData.length;
      const gridWidth = window.innerWidth - 100;
      const gridHeight = window.innerHeight - 200;
      const gridArea = gridWidth * gridHeight;
      
      // í™”ë©´ ë¹„ë¡€ í¬ê¸° ê³„ì‚° (vw ë‹¨ìœ„)
      const minSizeVw = 12; // ìµœì†Œ í¬ê¸°: í™”ë©´ ë„ˆë¹„ì˜ 12% (ìˆ˜ë°± ê°œê¹Œì§€ ìŒ“ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì‘ê²Œ)
      const maxSizeVw = 24; // ìµœëŒ€ í¬ê¸°: í™”ë©´ ë„ˆë¹„ì˜ 24% (ì „ì²´ì ìœ¼ë¡œ ì‚´ì§ ì¤„ì„)
      
      let itemSizeVw, maxImgSizeVw;
      
      if (itemCount < 3) {
        // 3ê°œ ì „ê¹Œì§€: ìµœëŒ€ í¬ê¸° ìœ ì§€
        itemSizeVw = maxSizeVw;
        maxImgSizeVw = maxSizeVw;
      } else if (itemCount < 8) {
        // 3~7ê°œ: ì•½ê°„ ì¤„ì–´ë“¦
        itemSizeVw = maxSizeVw * 0.85; // 85% í¬ê¸°
        maxImgSizeVw = maxSizeVw * 0.85;
      } else if (itemCount < 15) {
        // 8~14ê°œ: ì¤‘ê°„ í¬ê¸°
        itemSizeVw = maxSizeVw * 0.7; // 70% í¬ê¸°
        maxImgSizeVw = maxSizeVw * 0.7;
      } else if (itemCount < 25) {
        // 15~24ê°œ: ì‘ì•„ì§€ê¸° ì‹œì‘
        itemSizeVw = maxSizeVw * 0.6; // 60% í¬ê¸°
        maxImgSizeVw = maxSizeVw * 0.6;
      } else if (itemCount < 50) {
        // 25~49ê°œ: ë” ì‘ì•„ì§
        itemSizeVw = maxSizeVw * 0.5; // 50% í¬ê¸°
        maxImgSizeVw = maxSizeVw * 0.5;
      } else if (itemCount < 100) {
        // 50~99ê°œ: ê³„ì† ì‘ì•„ì§
        itemSizeVw = maxSizeVw * 0.4; // 40% í¬ê¸°
        maxImgSizeVw = maxSizeVw * 0.4;
      } else {
        // 100ê°œ ì´í›„: í™”ë©´ì˜ ì¼ì • ë¹„ìœ¨ì„ ì±„ìš¸ ìˆ˜ ìˆë„ë¡ í¬ê¸° ê³„ì‚°
        const targetAreaPerItem = gridArea * 0.06; // í™”ë©´ ë©´ì ì˜ 6%
        const estimatedItemArea = targetAreaPerItem / 1.5; // ì—¬ìœ  ê³µê°„ 1.5ë°° ê³ ë ¤
        const itemSizePx = Math.sqrt(estimatedItemArea); // ì •ì‚¬ê°í˜• ê°€ì •
        // í”½ì…€ì„ vwë¡œ ë³€í™˜
        itemSizeVw = (itemSizePx / window.innerWidth) * 100;
        maxImgSizeVw = itemSizeVw;
        
        // ìµœì†Œ/ìµœëŒ€ í¬ê¸° ì œí•œ (vw ë‹¨ìœ„)
        itemSizeVw = Math.max(minSizeVw, Math.min(maxSizeVw * 0.35, itemSizeVw));
        maxImgSizeVw = itemSizeVw;
      }
      
      // í”½ì…€ í¬ê¸°ë„ ê³„ì‚° (ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ìš©)
      const itemSize = (itemSizeVw / 100) * window.innerWidth;
      const maxImgSize = (maxImgSizeVw / 100) * window.innerWidth;
      
      console.log(`ğŸ“Š ì•„ì¹´ì´ë¸Œ í•­ëª© ê°œìˆ˜: ${itemCount}ê°œ, ì•„ì´í…œ í¬ê¸°: ${itemSize}px`);
      
      archiveGrid.innerHTML = sortedData.map((item, index) => {
        
        const date = new Date(item.timestamp);
        const dateString = date.toLocaleDateString('ko-KR');
        const timeString = date.toLocaleTimeString('ko-KR', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        
        // right_circle.svg ë°°ê²½ì— ë“œë˜ê·¸ ì´ë¯¸ì§€ë“¤ í‘œì‹œ
        let ticketContent = '';
        let overlayContent = ''; // ì˜¤ë²„ë ˆì´ ë¼ì¸ê³¼ í…ìŠ¤íŠ¸
        
        // ì €ì¥ëœ right_circle ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ìš°ì„  ì‚¬ìš© (ê°€ì¥ ì •í™•)
        // íˆ¬ëª… ë°°ê²½ìœ¼ë¡œ ìº¡ì²˜ëœ ì™„ì „í•œ ì´ë¯¸ì§€ì´ë¯€ë¡œ, ì›ë³¸ í¬ê¸°ì™€ ë¹„ìœ¨ì„ ì •í™•íˆ ìœ ì§€
        // object-fit ì‚¬ìš© ì‹œ ë°°ì¹˜ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì´ë¯¸ì§€ ë¡œë“œ í›„ ìì—°ìŠ¤ëŸ¬ìš´ í¬ê¸° ìœ ì§€
        if (item.rightCircleImage) {
          // ì••ì¶•ëœ ì´ë¯¸ì§€ëŠ” í¬ê¸°ë¥¼ ë” ì‘ê²Œ í‘œì‹œ (í•´ìƒë„ê°€ ë‚®ìœ¼ë¯€ë¡œ)
          const isCompressed = item.compressed || false;
          const displayMaxSizeVw = isCompressed ? maxImgSizeVw * 0.7 : maxImgSizeVw; // ì••ì¶•ëœ ì´ë¯¸ì§€ëŠ” 70% í¬ê¸°
          
          ticketContent = `
            <div class="ticket-container" style="position: relative; display: inline-block; margin: 0 auto; background: transparent; line-height: 0;">
              <img src="${item.rightCircleImage}" alt="í‹°ì¼“ right_circle ì˜ì—­" 
                   style="display: block; width: auto; height: auto; max-width: ${displayMaxSizeVw}vw; max-height: ${displayMaxSizeVw}vw; border: 0 !important; outline: 0 !important; background: transparent !important; image-rendering: auto;"
                   onload="(function(img) {
                     // ì´ë¯¸ì§€ì˜ ìì—°ìŠ¤ëŸ¬ìš´ í¬ê¸°ë¥¼ ìœ ì§€í•˜ë©´ì„œ max í¬ê¸°ë§Œ ì œí•œ (vw ë‹¨ìœ„)
                     const naturalWidth = img.naturalWidth;
                     const naturalHeight = img.naturalHeight;
                     const maxSizeVw = ${displayMaxSizeVw};
                     const maxSizePx = (maxSizeVw / 100) * window.innerWidth;
                     
                     let displayWidth = naturalWidth;
                     let displayHeight = naturalHeight;
                     
                     // ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©´ì„œ max í¬ê¸° ë‚´ë¡œ ì¡°ì •
                     if (displayWidth > maxSizePx) {
                       const ratio = maxSizePx / displayWidth;
                       displayWidth = maxSizePx;
                       displayHeight = displayHeight * ratio;
                     }
                     if (displayHeight > maxSizePx) {
                       const ratio = maxSizePx / displayHeight;
                       displayHeight = maxSizePx;
                       displayWidth = displayWidth * ratio;
                     }
                     
                     // vw ë‹¨ìœ„ë¡œ ë³€í™˜í•˜ì—¬ ì„¤ì •
                     const displayWidthVw = (displayWidth / window.innerWidth) * 100;
                     const displayHeightVw = (displayHeight / window.innerWidth) * 100;
                     img.style.width = displayWidthVw + 'vw';
                     img.style.height = displayHeightVw + 'vw';
                   })(this);">
            </div>
          `;
        } else if (item.imagePositions && item.imagePositions.length > 0) {
          // ì»¨í…Œì´ë„ˆë¥¼ ì •ì‚¬ê°í˜•ìœ¼ë¡œ ë§Œë“¤ì–´ ì›í˜• ëª¨ì–‘ ìœ ì§€
          // right_circle.svgë¥¼ ë°°ê²½ìœ¼ë¡œ ì‚¬ìš© (ì›í˜• ì»¨í…Œì´ë„ˆë¡œ ì œí•œ)
          ticketContent = `
            <div class="ticket-container" style="position: relative; width: 100%; aspect-ratio: 1; max-width: ${maxImgSizeVw}vw; max-height: ${maxImgSizeVw}vw; margin: 0 auto; background: url('result/ticket/right_circle.svg') no-repeat center center; background-size: contain;">
              ${item.imagePositions.map(imgData => {
                // ìƒˆ í˜•ì‹: relativeLeft, relativeTop ë“± ì‚¬ìš© (right_circle ê¸°ì¤€ 0~1 ë²”ìœ„)
                if (imgData.relativeLeft !== undefined) {
                  // right_circle.svgì˜ ì‹¤ì œ í‘œì‹œ ì˜ì—­ì„ ê¸°ì¤€ìœ¼ë¡œ í¼ì„¼íŠ¸ ë³€í™˜
                  // ìƒëŒ€ ìœ„ì¹˜ë¥¼ ê·¸ëŒ€ë¡œ í¼ì„¼íŠ¸ë¡œ ì‚¬ìš© (right_circle ë‚´ë¶€ ê¸°ì¤€)
                  const leftPercent = (imgData.relativeLeft * 100).toFixed(4);
                  const topPercent = (imgData.relativeTop * 100).toFixed(4);
                  const widthPercent = (imgData.relativeWidth * 100).toFixed(4);
                  const heightPercent = (imgData.relativeHeight * 100).toFixed(4);
                  
                  return `
                    <img src="${imgData.src}" alt="${imgData.alt || ''}"
                         style="position: absolute; left: ${leftPercent}%; top: ${topPercent}%; 
                                width: ${widthPercent}%; height: ${heightPercent}%; 
                                object-fit: contain; z-index: 10;
                                border: 0 !important; outline: 0 !important; background: transparent !important;
                                transform: ${imgData.transform || ''}; pointer-events: none;
                                transform-origin: center center;"
                         onerror="console.log('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', '${imgData.src}');">
                  `;
                }
                // í•˜ìœ„ í˜¸í™˜ì„±: ê¸°ì¡´ left/top í˜•ì‹
                else {
                  const leftPercent = parseFloat(imgData.left) || 0;
                  const topPercent = parseFloat(imgData.top) || 0;
                  let widthStyle = '';
                  let heightStyle = '';
                  
                  if (imgData.width && imgData.height) {
                    const width = parseFloat(imgData.width);
                    const height = parseFloat(imgData.height);
                    widthStyle = `${Math.max(width * 0.15, 8)}px`;
                    heightStyle = `${Math.max(height * 0.15, 8)}px`;
                  } else {
                    widthStyle = `${(parseFloat(imgData.width) || 10) * 0.5}%`;
                    heightStyle = 'auto';
                  }
                  
                  return `
                    <img src="${imgData.src}" alt="${imgData.alt || ''}"
                         style="position: absolute; left: ${leftPercent}%; top: ${topPercent}%; 
                                width: ${widthStyle}; height: ${heightStyle}; 
                                object-fit: contain; z-index: 10;
                                border: 0 !important; outline: 0 !important; background: transparent !important;
                                transform: ${imgData.transform || ''}; pointer-events: none;"
                         onerror="console.log('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', '${imgData.src}');">
                  `;
                }
              }).join('')}
            </div>
          `;
        } else if (item.rightImagePositions && item.rightImagePositions.length > 0) {
          // í•˜ìœ„ í˜¸í™˜ì„±: rightImagePositions ì‚¬ìš©
          ticketContent = `
            <div class="ticket-container" style="position: relative; width: 100%; aspect-ratio: 1; max-width: ${maxImgSizeVw}vw; max-height: ${maxImgSizeVw}vw; margin: 0 auto; background: url('result/ticket/right_circle.svg') no-repeat center center; background-size: contain;">
              ${item.rightImagePositions.map(imgData => `
                <img src="${imgData.src}" alt=""
                     style="position: absolute; right: ${imgData.right || 50}%; top: ${imgData.top || 50}%; 
                            width: auto; height: auto; max-width: 30px; max-height: 30px; z-index: 10;
                            border: 0 !important; outline: 0 !important; background: transparent !important;"
                     onload="this.style.width = (this.naturalWidth * ${imgData.alt.includes('ë°”ì´ì˜¬ë¦°') || imgData.alt.includes('ë¹„ì˜¬ë¼') || imgData.alt.includes('ì²¼ë¡œ') || imgData.alt.includes('íŠ¸ëŸ¼ë³¸') || imgData.alt.includes('íŠ¸ëŸ¼í«') || imgData.alt.includes('í˜¸ë¥¸') || imgData.alt.includes('í”Œë£»') || imgData.alt.includes('í´ë¼ë¦¬ë„·') || imgData.alt.includes('ì½˜íŠ¸ë¼ë² ì´ìŠ¤') ? '0.25' : '0.5'}) + 'px'; this.style.height = (this.naturalHeight * ${imgData.alt.includes('ë°”ì´ì˜¬ë¦°') || imgData.alt.includes('ë¹„ì˜¬ë¼') || imgData.alt.includes('ì²¼ë¡œ') || imgData.alt.includes('íŠ¸ëŸ¼ë³¸') || imgData.alt.includes('íŠ¸ëŸ¼í«') || imgData.alt.includes('í˜¸ë¥¸') || imgData.alt.includes('í”Œë£»') || imgData.alt.includes('í´ë¼ë¦¬ë„·') || imgData.alt.includes('ì½˜íŠ¸ë¼ë² ì´ìŠ¤') ? '0.25' : '0.5'}) + 'px';"
                     onerror="console.log('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', '${imgData.src}');">
              `).join('')}
            </div>
          `;
        } else {
          // ê¸°ì¡´ ìº¡ì³ ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš° (í•˜ìœ„ í˜¸í™˜ì„±)
          ticketContent = `
            <div class="ticket-container" style="position: relative; width: 100%; aspect-ratio: 1; max-width: ${maxImgSizeVw}vw; max-height: ${maxImgSizeVw}vw; margin: 0 auto; background: url('result/ticket/right_circle.svg') no-repeat center center; background-size: contain;">
              ${item.image ? `<img src="${item.image}" alt="í‹°ì¼“ ì´ë¯¸ì§€" style="width: 100%; height: 100%; object-fit: contain;">` : ''}
            </div>
          `;
        }

        // í°íŠ¸ í¬ê¸° ë™ì  ê³„ì‚° (ê·¸ë˜í”½ í¬ê¸°ì— ë¹„ë¡€í•˜ë˜ í…ìŠ¤íŠ¸ê°€ ê³¼ë„í•˜ê²Œ ì»¤ì§€ì§€ ì•Šë„ë¡)
        // vw ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚° (í™”ë©´ ë¹„ë¡€)
        // 20vwë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ë˜, ê·¸ë˜í”½ í¬ê¸° ë³€í™”ì— í…ìŠ¤íŠ¸ëŠ” ë” ì‘ê²Œ ë°˜ì‘ (0.6ë°°)
        const baseFontSizeVw = 20; // ê¸°ì¤€ ê·¸ë˜í”½ í¬ê¸° (vw)
        const fontSizeRatio = 0.6; // í…ìŠ¤íŠ¸ ë³€í™” ë¹„ìœ¨ (ê·¸ë˜í”½ë³´ë‹¤ ì‘ê²Œ)
        const normalizedScale = 1 + (maxImgSizeVw - baseFontSizeVw) / baseFontSizeVw * fontSizeRatio;
        // vw ë‹¨ìœ„ë¡œ ê³„ì‚° (í™”ë©´ ë¹„ë¡€)
        const baseFontSizeVwValue = 0.7; // ê¸°ì¤€ í°íŠ¸ í¬ê¸° (vw)
        const stageInfoFontSizeVw = baseFontSizeVwValue * normalizedScale;
        const stageInfoFontSize = `${stageInfoFontSizeVw}vw`;
        
        // ì˜¤ë²„ë ˆì´ í…ìŠ¤íŠ¸ í¬ê¸° (ì•½ê°„ ë” ì‘ê²Œ)
        const overlayFontSizeVw = baseFontSizeVwValue * normalizedScale * 0.9;
        const overlayFontSize = `${overlayFontSizeVw}vw`;
        
        // ìŠ¤í…Œì´ì§€ ì •ë³´ ìƒì„±
        // ê·¸ë˜í”½ í¬ê¸°ì— ì •í™•íˆ ë¹„ë¡€í•˜ì—¬ í…ìŠ¤íŠ¸ ìœ„ì¹˜ ì¡°ì • (ë” ê°€ê¹ê²Œ)
        // vw ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
        const baseSizeForPositionVw = 20; // ê¸°ì¤€ í¬ê¸° (vw)
        const positionScale = maxImgSizeVw / baseSizeForPositionVw;
        // bottom ìœ„ì¹˜ë¥¼ ê·¸ë˜í”½ í¬ê¸°ì— ë¹„ë¡€í•˜ì—¬ ì¡°ì • (20vwì¼ ë•Œ -1vwë¡œ ì¤„ì—¬ì„œ ë” ê°€ê¹ê²Œ)
        const bottomOffsetVw = -1 * positionScale;
        const bottomOffset = `${bottomOffsetVw}vw`;
        
        let stageInfoHTML = '';
        if (item.selections) {
          const stageInfo = generateStageInfo(item.selections, item.timestamp);
          if (stageInfo) {
            stageInfoHTML = `
              <div class="archive-stage-info" style="font-size: ${stageInfoFontSize}; bottom: ${bottomOffset};">
                <span class="stage-name">${stageInfo.stageName}</span>
                <span class="stage-datetime">${stageInfo.dateTime}</span>
              </div>
            `;
          }
        }
        
        // ticket-info ìœ„ì¹˜ë„ ê·¸ë˜í”½ í¬ê¸°ì— ë¹„ë¡€í•˜ì—¬ ì¡°ì • (ë” ê°€ê¹ê²Œ)
        const ticketInfoTopOffsetVw = maxImgSizeVw * 0.03; // ê·¸ë˜í”½ í¬ê¸°ì˜ 3% ì•„ë˜ (vw)
        const ticketInfoTopOffset = `${ticketInfoTopOffsetVw}vw`;
        
        return `
          <div class="archive-item" onclick="viewTicket('${item.id}')">
            ${ticketContent}
            ${stageInfoHTML}
            <div class="ticket-info" style="margin-top: ${ticketInfoTopOffset}px;">
              <div class="ticket-date">${dateString} ${timeString}</div>
            </div>
          </div>
        `;
      }).join('');
      
      // ì»¨í…Œì´ë„ˆ í¬ê¸° ê³„ì‚° (DOMì´ ë Œë”ë§ëœ í›„)
      setTimeout(() => {
        const padding = 50;
        const gridWidth = archiveGrid.offsetWidth || window.innerWidth - 100;
        // ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ë†’ì´ëŠ” ë‚´ìš©ì— ë§ê²Œ ìë™ ì¡°ì •
        // ìµœì†Œ ë†’ì´ë§Œ ì„¤ì •í•˜ê³ , ë‚´ìš©ì´ ë§ìœ¼ë©´ ìë™ìœ¼ë¡œ ëŠ˜ì–´ë‚˜ë„ë¡
        const minGridHeight = window.innerHeight - 200;
        // ì•„ì´í…œ ê°œìˆ˜ì— ë”°ë¼ í•„ìš”í•œ ìµœì†Œ ë†’ì´ ê³„ì‚° (ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•œ ì—¬ìœ  ê³µê°„ í¬í•¨)
        const estimatedNeededHeight = Math.max(
          minGridHeight,
          Math.ceil(Math.sqrt(itemCount)) * (itemSize + padding * 2) + padding * 2
        );
        archiveGrid.style.minHeight = `${estimatedNeededHeight}px`;
        const gridHeight = Math.max(estimatedNeededHeight, archiveGrid.offsetHeight || minGridHeight);
        
        // ê° ì•„ì´í…œì— ëœë¤ ìœ„ì¹˜ ì ìš© ë° ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ì´ˆê¸°í™”
        const archiveItems = archiveGrid.querySelectorAll('.archive-item');
        const items = []; // ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ìš© ì•„ì´í…œ ë°°ì—´
        
        // ë§ˆì§€ë§‰ìœ¼ë¡œ ë³¸ ìµœì‹  timestamp í™•ì¸
        const lastViewedTimestamp = parseInt(localStorage.getItem(LAST_VIEWED_KEY) || '0');
        const currentLatestTimestamp = sortedData.length > 0 ? sortedData[0].timestamp : 0;
        
        // ìƒˆë¡œìš´ ì•„ì´í…œì´ ìˆëŠ”ì§€ í™•ì¸ (í˜„ì¬ ìµœì‹  ì•„ì´í…œì´ ë§ˆì§€ë§‰ìœ¼ë¡œ ë³¸ ê²ƒë³´ë‹¤ ìµœì‹ ì¸ ê²½ìš°)
        const hasNewItems = currentLatestTimestamp > lastViewedTimestamp;
        
        archiveItems.forEach((itemEl, index) => {
          const maxX = Math.max(0, gridWidth - itemSize - padding);
          const maxY = Math.max(0, gridHeight - itemSize - padding);
          
          // ëœë¤ ìœ„ì¹˜ ìƒì„± (ìƒˆë¡œìš´ ì•„ì´í…œì€ ìœ„ìª½ì—, ì˜¤ë˜ëœ ì•„ì´í…œì€ ì•„ë˜ìª½ì—)
          const itemTimestamp = sortedData[index]?.timestamp || Date.now();
          const age = Date.now() - itemTimestamp; // ì•„ì´í…œì˜ ë‚˜ì´ (ë°€ë¦¬ì´ˆ)
          const ageInSeconds = age / 1000; // ì´ˆ ë‹¨ìœ„
          
          // ìƒˆë¡œìš´ ì•„ì´í…œì€ ìœ„ìª½ì—, ì˜¤ë˜ëœ ì•„ì´í…œì€ ì•„ë˜ìª½ì— ë°°ì¹˜
          const yBias = Math.min(ageInSeconds / 300, 0.7); // 5ë¶„ ì§€ë‚˜ë©´ ì•„ë˜ìª½ìœ¼ë¡œ 70% ì´ë™
          const randomX = padding + Math.random() * maxX;
          const randomY = padding + Math.random() * (maxY * (1 - yBias * 0.3)); // ìœ„ìª½ì— ë” ë§ì´ ë°°ì¹˜
          
          // ì²« ë²ˆì§¸ ì•„ì´í…œ(ê°€ì¥ ìµœì‹ )ì´ ìƒˆë¡œìš´ ì•„ì´í…œì¸ ê²½ìš° ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
          if (index === 0 && hasNewItems) {
            itemEl.classList.add('new-item');
            console.log('âœ¨ ìƒˆë¡œìš´ ì•„ì´í…œ ê°ì§€! ë°˜ì§ì„ ì• ë‹ˆë©”ì´ì…˜ ì ìš©');
            
            // 10ì´ˆ í›„ ì• ë‹ˆë©”ì´ì…˜ ì œê±°
            setTimeout(() => {
              itemEl.classList.add('fade-out');
              setTimeout(() => {
                itemEl.classList.remove('new-item', 'fade-out');
                // ë§ˆì§€ë§‰ìœ¼ë¡œ ë³¸ timestamp ì—…ë°ì´íŠ¸
                localStorage.setItem(LAST_VIEWED_KEY, currentLatestTimestamp.toString());
              }, 1000);
            }, 10000);
          }
          
          // ëœë¤ íšŒì „ ê°ë„ (-30ë„ ~ +30ë„) - ë” í° ë²”ìœ„
          const randomRotate = (Math.random() - 0.5) * 60;
          
          // ì• ë‹ˆë©”ì´ì…˜ ì¤‘ ì¶”ê°€ íšŒì „ ë³€ë™ëŸ‰ (-20ë„ ~ +20ë„)
          const rotateDelta = (Math.random() - 0.5) * 40;
          
          // ëœë¤ ì• ë‹ˆë©”ì´ì…˜ ë”œë ˆì´ (0~6ì´ˆ) - ë” ê¸´ ë”œë ˆì´
          const animationDelay = Math.random() * 6;
          
          // ëœë¤ ì• ë‹ˆë©”ì´ì…˜ ì§€ì† ì‹œê°„ (6~12ì´ˆ) - ë” ê¸´ ì§€ì† ì‹œê°„
          const animationDuration = 6 + Math.random() * 6;
          
          // CSS ë³€ìˆ˜ë¡œ rotate ì €ì¥ (ì• ë‹ˆë©”ì´ì…˜ì—ì„œ ì‚¬ìš©)
          itemEl.style.setProperty('--rotate', `${randomRotate}deg`);
          itemEl.style.setProperty('--rotate-delta', `${rotateDelta}deg`);
          itemEl.style.animationDelay = `${animationDelay}s`;
          itemEl.style.animationDuration = `${animationDuration}s`;
          
          // ì´ˆê¸° ìœ„ì¹˜ë¥¼ transformìœ¼ë¡œ ì„¤ì • (left/top ëŒ€ì‹ )
          itemEl.style.transform = `translate3d(${randomX}px, ${randomY}px, 0) rotate(${randomRotate}deg)`;
          itemEl.style.left = '0';
          itemEl.style.top = '0';
          
          // ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ì´ˆê¸°í™” (ìƒì„± ì‹œê°„ í¬í•¨)
          const birthTime = Date.now(); // ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ ì‹œì 
          
          // ì´ˆê¸° í™œë™ì„± ê³„ì‚° (ë‚˜ì´ì— ë”°ë¼)
          let initialActivity = 1.0;
          if (ageInSeconds > 600) { // 10ë¶„ = 600ì´ˆ (ë” ëŠ¦ê²Œ ê°ì†Œ ì‹œì‘)
            initialActivity = Math.max(0, 1 - (ageInSeconds - 600) / 600); // 10ë¶„ í›„ë¶€í„° ê°ì†Œ, 20ë¶„ì— 0
          }
          
          const itemData = {
            element: itemEl,
            x: randomX,
            y: randomY,
            rotate: randomRotate,
            vx: (Math.random() - 0.5) * 1.8 * initialActivity, // ì´ˆê¸° ì†ë„ ì¦ê°€ (0.8 â†’ 1.8)
            vy: (Math.random() - 0.5) * 1.8 * initialActivity,
            radius: itemSize / 2,
            bounceTime: 0, // íŠ•ê¹€ íš¨ê³¼ ì§€ì† ì‹œê°„
            bounceForce: { x: 0, y: 0 }, // íŠ•ê¹€ í˜
            isHovered: false, // hover ìƒíƒœ
            birthTime: birthTime, // ìƒì„± ì‹œì 
            age: ageInSeconds // ì•„ì´í…œì˜ ì‹¤ì œ ë‚˜ì´ (ì´ˆ)
          };
          
          // hover ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          itemEl.addEventListener('mouseenter', () => {
            itemData.isHovered = true;
          });
          itemEl.addEventListener('mouseleave', () => {
            itemData.isHovered = false;
          });
          
          items.push(itemData);
        });
        
        // ì˜¤ë²„ë ˆì´ ë¼ì¸ ìë™ ì „í™˜ ì‹œì‘ (í˜„ì¬ í¬ê¸° ì •ë³´ ì „ë‹¬)
        startOverlayRotation(archiveItems, sortedData, maxImgSizeVw);
        
        // ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
        if (items.length > 0) {
          console.log(`ğŸš€ ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘: ${items.length}ê°œ ì•„ì´í…œ`);
          startPhysicsSimulation(items, gridWidth, gridHeight, itemSize);
        } else {
          console.warn('âš ï¸ ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜í•  ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.');
        }
      }, 200); // ì•½ê°„ ë” ëŠ¦ê²Œ ì‹œì‘ (DOM ë Œë”ë§ ì™„ë£Œ ëŒ€ê¸°)
    }
    
    // ë¹ˆ ìƒíƒœ í‘œì‹œ
    function showEmptyState() {
      document.getElementById('archiveGrid').style.display = 'none';
      document.getElementById('emptyState').style.display = 'block';
    }
    
    // ìŠ¤í…Œì´ì§€ ì •ë³´ ìƒì„±
    function generateStageInfo(selections, timestamp) {
      // ì •í™•í•œ ì´ë‹ˆì…œ ë§¤í•‘ (app.jsì˜ ì‹¤ì œ ì €ì¥ í‚¤ê°’ ì‚¬ìš©)
      const initialsMap = {
        // Place (ì˜ì–´ ì²« ê¸€ì)
        'lawn': 'L',      // Lawn
        'forest': 'F',    // Forest
        'valley': 'V',    // Valley
        'sea': 'S',       // Sea
        // Mood (ì˜ì–´ ì²« ê¸€ì)
        'baroque': 'B',           // Baroque
        'romantic': 'R',          // Romanticism
        'impression': 'I',        // Impressionism
        'post': 'P',              // Postmodernism
        // Flow (ì˜ì–´ ì²« ê¸€ì)
        'recline': 'R',   // Recline
        'lounge': 'L',    // Lounge
        'settle': 'S',    // Settle
        'wander': 'W',    // Wander
        // Extras (ì˜ì–´ ì²« ê¸€ì)
        'dialogue': 'D',        // Dialogue
        'refresh': 'R',         // Refreshment
        'play': 'P',            // Playground
        'fire': 'F'             // Fireworks
      };
      
      const initials = [
        initialsMap[selections.place] || 'X',
        initialsMap[selections.mood] || 'X',
        initialsMap[selections.flow] || 'X',
        initialsMap[selections.extras] || 'X'
      ].join('');
      
      const stageName = `${initials} Stage`;
      
      // ë‚ ì§œ/ì‹œê°„ í¬ë§·
      const date = new Date(timestamp);
      const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '/');
      const timeStr = date.toTimeString().slice(0, 5);
      
      return {
        stageName: stageName,
        dateTime: `${dateStr}<br>${timeStr}`
      };
    }
    
    // ì˜¤ë²„ë ˆì´ ë¼ì¸ê³¼ ì„ íƒì§€ ì •ë³´ ì¶”ê°€
    function addOverlayToItem(itemElement, itemData, overlayLineNum, maxImgSizeVw) {
      // ì˜¤ë²„ë ˆì´ ë¼ì¸ ì„ íƒ (1~5)
      const overlayLinePath = `archive/overlay_line${overlayLineNum}.svg`;
      
      // ì„ íƒì§€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const selections = itemData.selections || {};
      
      // í•œê¸€ ë ˆì´ë¸” ë§¤í•‘
      const placeLabels = {
        'lawn': 'ë“¤íŒ',
        'forest': 'ìˆ²ì†',
        'valley': 'ê³„ê³¡',
        'sea': 'ë°”ë‹·ê°€'
      };
      
      const moodLabels = {
        'baroque': 'ì •êµí•œ ì„ ìœ¨',
        'romanticism': 'ê°•ë ¬í•œ ê°ì •',
        'impressionism': 'ëª½í™˜ì  ìŒìƒ‰',
        'postmodernism': 'ììœ ë¡œìš´ í˜•ì‹'
      };
      
      const flowLabels = {
        'recline': 'í¸ì•ˆíˆ ëˆ„ì›Œ',
        'lounge': 'ììœ ë¡­ê²Œ ì•‰ì•„',
        'settle': 'ì¢Œì„ì—ì„œ ëª°ì…í•´',
        'wander': 'ê°€ë³ê²Œ ëŒì•„ë‹¤ë‹ˆë©°'
      };
      
      const extrasLabels = {
        'dialogue': 'ì—°ì£¼ìì™€ ì†Œí†µìœ¼ë¡œ',
        'refreshment': 'ë‹¤ê³¼ ì‹œê°„ìœ¼ë¡œ',
        'playground': 'ìŒì•… í”Œë ˆì´ì¡´ìœ¼ë¡œ',
        'fireworks': 'ë¶ˆë¹› ë§ˆë‹¹ìœ¼ë¡œ'
      };
      
      // ì•…ê¸° í•œê¸€ëª… ìœ ì§€ (ì˜ì–´ ì•½ì ì‚¬ìš© ì•ˆ í•¨)
      const instrumentKoreanLabels = {
        'ë°”ì´ì˜¬ë¦°': 'ë°”ì´ì˜¬ë¦°',
        'ë¹„ì˜¬ë¼': 'ë¹„ì˜¬ë¼',
        'ì²¼ë¡œ': 'ì²¼ë¡œ',
        'íŠ¸ëŸ¼ë³¸': 'íŠ¸ëŸ¼ë³¸',
        'íŠ¸ëŸ¼í«': 'íŠ¸ëŸ¼í«',
        'í˜¸ë¥¸': 'í˜¸ë¥¸',
        'í”Œë£»': 'í”Œë£»',
        'í´ë¼ë¦¬ë„·': 'í´ë¼ë¦¬ë„·',
        'ì½˜íŠ¸ë¼ë² ì´ìŠ¤': 'ì½˜íŠ¸ë¼ë² ì´ìŠ¤'
      };
      
      // ì„ íƒì§€ í…ìŠ¤íŠ¸ ìƒì„± (í•´ë‹¹ ê·¸ë˜í”½ì„ êµ¬ì„±í•˜ëŠ” ì„ íƒì§€ë§Œ í‘œì‹œ - ì˜¤ë¡œì§€ í•œê¸€ë§Œ)
      const selectionParts = [];
      
      if (selections.place) {
        const placeText = placeLabels[selections.place];
        if (placeText) selectionParts.push(placeText);
      }
      if (selections.mood) {
        const moodText = moodLabels[selections.mood];
        if (moodText) selectionParts.push(moodText);
      }
      if (selections.flow) {
        const flowText = flowLabels[selections.flow];
        if (flowText) selectionParts.push(flowText);
      }
      if (selections.extras) {
        const extrasText = extrasLabels[selections.extras];
        if (extrasText) selectionParts.push(extrasText);
      }
      if (selections.instruments && Array.isArray(selections.instruments) && selections.instruments.length > 0) {
        const instrumentText = selections.instruments.slice(0, 3)
          .map(inst => instrumentKoreanLabels[inst] || inst)
          .join(' ');
        if (instrumentText) {
          selectionParts.push(instrumentText);
        }
      }
      
      // ê° ì„ íƒì§€ë¥¼ spanìœ¼ë¡œ ê°ì‹¸ì„œ ì¤„ë„˜ê¹€ ë°©ì§€
      const selectionText = selectionParts.length > 0 
        ? selectionParts.map(part => `<span class="selection-item">${part}</span>`).join('') 
        : '';
      
      // í°íŠ¸ í¬ê¸° ë™ì  ê³„ì‚° (ê·¸ë˜í”½ í¬ê¸°ì— ë¹„ë¡€í•˜ë˜ í…ìŠ¤íŠ¸ê°€ ê³¼ë„í•˜ê²Œ ì»¤ì§€ì§€ ì•Šë„ë¡)
      // vw ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚° (í™”ë©´ ë¹„ë¡€)
      // 20vwë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ë˜, ê·¸ë˜í”½ í¬ê¸° ë³€í™”ì— í…ìŠ¤íŠ¸ëŠ” ë” ì‘ê²Œ ë°˜ì‘ (0.6ë°°)
      const baseFontSizeVw = 20; // ê¸°ì¤€ ê·¸ë˜í”½ í¬ê¸° (vw)
      const fontSizeRatio = 0.6; // í…ìŠ¤íŠ¸ ë³€í™” ë¹„ìœ¨ (ê·¸ë˜í”½ë³´ë‹¤ ì‘ê²Œ)
      const normalizedScale = 1 + (maxImgSizeVw - baseFontSizeVw) / baseFontSizeVw * fontSizeRatio;
      // vw ë‹¨ìœ„ë¡œ ê³„ì‚° (í™”ë©´ ë¹„ë¡€)
      const baseFontSizeVwValue = 0.7; // ê¸°ì¤€ í°íŠ¸ í¬ê¸° (vw)
      const overlayFontSizeVw = baseFontSizeVwValue * normalizedScale * 0.9;
      const overlayFontSize = `${overlayFontSizeVw}vw`;
      
      // ì˜¤ë²„ë ˆì´ HTML ìƒì„± (ì„ íƒì§€ê°€ ìˆì„ ë•Œë§Œ)
      let overlayHTML = '';
      if (selectionText) {
        overlayHTML = `
          <div class="overlay-line-wrapper">
            <img src="${overlayLinePath}" alt="ì˜¤ë²„ë ˆì´ ë¼ì¸" class="overlay-line">
            <div class="overlay-text" style="font-size: ${overlayFontSize};">
              ${selectionText}
            </div>
          </div>
        `;
      }
      
      // ì˜¤ë²„ë ˆì´ ì¶”ê°€
      itemElement.insertAdjacentHTML('beforeend', overlayHTML);
    }
    
    // ì˜¤ë²„ë ˆì´ ìë™ ì „í™˜
    let overlayRotationInterval = null;
    
    function startOverlayRotation(archiveItems, sortedData, maxImgSizeVw) {
      // ê¸°ì¡´ ì¸í„°ë²Œ ì •ë¦¬
      if (overlayRotationInterval) {
        clearInterval(overlayRotationInterval);
      }
      
      if (archiveItems.length === 0 || sortedData.length === 0) {
        return;
      }
      
      // ìµœì´ˆ ì˜¤ë²„ë ˆì´ ì¶”ê°€
      rotateOverlay(archiveItems, sortedData, maxImgSizeVw);
      
      // 4ì´ˆë§ˆë‹¤ ì˜¤ë²„ë ˆì´ ì „í™˜
      overlayRotationInterval = setInterval(() => {
        rotateOverlay(archiveItems, sortedData, maxImgSizeVw);
      }, 4000);
    }
    
    function rotateOverlay(archiveItems, sortedData, maxImgSizeVw) {
      // ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ì œê±°
      archiveItems.forEach(item => {
        const existingOverlay = item.querySelector('.overlay-line-wrapper');
        if (existingOverlay) {
          existingOverlay.remove();
        }
      });
      
      // ìƒˆë¡œìš´ ëœë¤ ì˜¤ë²„ë ˆì´ ì¶”ê°€
      const randomItemIndex = Math.floor(Math.random() * archiveItems.length);
      const randomItem = archiveItems[randomItemIndex];
      const correspondingData = sortedData[randomItemIndex];
      const randomOverlayLine = Math.floor(Math.random() * 5) + 1;
      
      if (randomItem && correspondingData) {
        addOverlayToItem(randomItem, correspondingData, randomOverlayLine, maxImgSizeVw);
      }
    }
    
    // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ ì¸í„°ë²Œ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
      if (overlayRotationInterval) {
        clearInterval(overlayRotationInterval);
      }
    });
    
    // ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ (ì¶©ëŒ ê°ì§€ ë° íŠ•ê¹€ íš¨ê³¼)
    let animationFrameId = null;
    let physicsRunning = false;
    
    function startPhysicsSimulation(items, gridWidth, gridHeight, itemSize) {
      if (physicsRunning) return;
      physicsRunning = true;
      
      const padding = 50;
      const minX = padding;
      const minY = padding;
      const maxX = gridWidth - itemSize - padding;
      const maxY = gridHeight - itemSize - padding;
      
      function updatePhysics() {
        // ê° ì•„ì´í…œ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        const currentTime = Date.now();
        const time = currentTime / 1000; // ì‹œê°„ì„ forEach ë°–ì—ì„œ ê³„ì‚°
        
        items.forEach((item, i) => {
          // ì•„ì´í…œì˜ ë‚˜ì´ ê³„ì‚° (ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ í›„ ê²½ê³¼ ì‹œê°„)
          const itemAge = (currentTime - item.birthTime) / 1000; // ì´ˆ ë‹¨ìœ„
          const totalAge = item.age + itemAge; // ì‹¤ì œ ë‚˜ì´ + ì‹œë®¬ë ˆì´ì…˜ ë‚˜ì´
          
          // í™œë™ì„± ê³„ì‚° (ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ê°ì†Œ)
          // 0~10ë¶„: í™œë°œ (1.0), 10~20ë¶„: ì¤‘ê°„ (0.5~1.0), 20ë¶„ ì´í›„: ì •ì§€ (0.0)
          let activity = 1.0;
          if (totalAge > 600) { // 10ë¶„ = 600ì´ˆ (ë” ëŠ¦ê²Œ ê°ì†Œ ì‹œì‘)
            activity = Math.max(0, 1 - (totalAge - 600) / 600); // 10ë¶„ í›„ë¶€í„° ì ì  ê°ì†Œ, 20ë¶„ì— 0
          }
          
          // í™œë™ì„±ì´ ë‚®ì•„ì§€ë©´ ë°”ë‹¥ìœ¼ë¡œ ë‚´ë ¤ê°€ê¸° ì‹œì‘
          if (activity < 0.3) {
            // ë°”ë‹¥ìœ¼ë¡œ ëŒì–´ë‹¹ê¸°ëŠ” íš¨ê³¼ (í™œë™ì„±ì´ ë‚®ì„ìˆ˜ë¡ ê°•í•¨)
            const targetY = maxY; // ë°”ë‹¥
            const distanceToBottom = targetY - item.y;
            const pullStrength = (1 - activity) * 0.15; // í™œë™ì„±ì´ ë‚®ì„ìˆ˜ë¡ ê°•í•˜ê²Œ ë‹¹ê¹€
            item.vy += distanceToBottom * pullStrength * 0.01; // ë°”ë‹¥ìœ¼ë¡œ ëŒì–´ë‹¹ê¹€
          }
          
          // í™œë™ì„±ì´ ë§¤ìš° ë‚®ìœ¼ë©´ ë°”ë‹¥ì— ì •ì°©
          if (activity < 0.1) {
            activity = 0;
            // ë°”ë‹¥ì— ì •ì°© (ì•„ë˜ìª½ìœ¼ë¡œ ê°•í•˜ê²Œ ì´ë™)
            const targetY = maxY; // ë°”ë‹¥
            const damping = 0.92; // ë” ê°•í•œ ê°ì‡ 
            if (Math.abs(item.y - targetY) > 2) {
              // ë°”ë‹¥ìœ¼ë¡œ ê°•í•˜ê²Œ ëŒì–´ë‹¹ê¹€
              item.vy += (targetY - item.y) * 0.05; // ì¤‘ë ¥ íš¨ê³¼ ê°•í™” (0.01 â†’ 0.05)
              item.vy *= damping;
              item.vx *= damping * 0.98; // ìˆ˜í‰ ë°©í–¥ë„ ë” ë¹ ë¥´ê²Œ ê°ì‡ 
            } else {
              // ë°”ë‹¥ì— ê±°ì˜ ë„ë‹¬í–ˆìœ¼ë©´ ì •ì°©
              item.y = targetY; // ë°”ë‹¥ì— ê³ ì •
              item.vy = 0; // ìˆ˜ì§ ì†ë„ ì œê±°
              item.vx *= 0.85; // ìˆ˜í‰ ì†ë„ë§Œ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆìŒ (ë” ë¹ ë¥´ê²Œ ê°ì‡ )
            }
          }
          
          // íŠ•ê¹€ í˜ ê°ì†Œ (ëŒí•‘, í™œë™ì„±ì— ë¹„ë¡€)
          if (item.bounceTime > 0) {
            const bounceStrength = 0.25 * activity; // í™œë™ì„±ì´ ë‚®ì„ìˆ˜ë¡ íŠ•ê¹€ ì•½í•¨
            item.vx += item.bounceForce.x * bounceStrength;
            item.vy += item.bounceForce.y * bounceStrength;
            item.bounceTime -= 1;
            
            if (item.bounceTime <= 0) {
              item.bounceForce = { x: 0, y: 0 };
            }
          }
          
          // ë– ë‹¤ë‹ˆëŠ” ì›€ì§ì„ (í™œë™ì„±ì— ë¹„ë¡€, í™œë™ì„±ì´ ë‚®ìœ¼ë©´ ìœ„ë¡œ ì˜¬ë¼ê°€ëŠ” í˜ ì œê±°)
          if (activity > 0.3) {
            const phase = (time + i * 0.5) * 0.3;
            const floatStrength = 0.15 * activity; // í™œë™ì„±ì— ë¹„ë¡€
            item.vx += Math.sin(phase) * floatStrength;
            // í™œë™ì„±ì´ ë‚®ì•„ì§€ë©´ ìœ„ë¡œ ì˜¬ë¼ê°€ëŠ” í˜ì„ ì œê±°
            if (activity > 0.5) {
              item.vy += Math.cos(phase * 1.3) * floatStrength;
            } else {
              // í™œë™ì„±ì´ ë‚®ìœ¼ë©´ ìœ„ë¡œ ì˜¬ë¼ê°€ì§€ ì•Šë„ë¡ (ì•„ë˜ë¡œë§Œ ê°€ê±°ë‚˜ ì¤‘ë¦½)
              const verticalFloat = Math.cos(phase * 1.3) * floatStrength;
              if (verticalFloat < 0) { // ìœ„ë¡œ ì˜¬ë¼ê°€ëŠ” í˜ë§Œ ì œê±°
                item.vy += verticalFloat * 0.5; // ì•½í•˜ê²Œë§Œ ì ìš©
              }
            }
          }
          
          // ì¤‘ë ¥ íš¨ê³¼ (í™œë™ì„±ì´ ë‚®ì„ìˆ˜ë¡ ë” ê°•í•˜ê²Œ, ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ë” ê°•í•´ì§)
          if (activity < 0.7) {
            // í™œë™ì„±ì´ ë‚®ì„ìˆ˜ë¡, ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ì¤‘ë ¥ ê°•í™”
            const gravityStrength = 0.03 + (1 - activity) * 0.05; // ë” ê°•í•œ ì¤‘ë ¥
            item.vy += gravityStrength; // ì•„ë˜ë¡œ ë–¨ì–´ì§
          }
          
          // ì†ë„ ì œí•œ (í™œë™ì„±ì— ë¹„ë¡€)
          const maxSpeed = 1.2 * activity + 0.3; // í™œë™ì„±ì´ ë‚®ì„ìˆ˜ë¡ ìµœëŒ€ ì†ë„ ê°ì†Œ (0.5 â†’ 1.2, ë” ë¹ ë¥´ê²Œ)
          item.vx = Math.max(-maxSpeed, Math.min(maxSpeed, item.vx));
          item.vy = Math.max(-maxSpeed, Math.min(maxSpeed, item.vy));
          
          // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
          item.x += item.vx;
          item.y += item.vy;
          
          // ê²½ê³„ ì¶©ëŒ (ë²½ì— íŠ•ê¹€)
          if (item.x < minX) {
            item.x = minX;
            item.vx *= -0.8; // ë°˜ë°œ ê³„ìˆ˜
            item.vy *= 0.95; // ë§ˆì°°
          } else if (item.x > maxX) {
            item.x = maxX;
            item.vx *= -0.8;
            item.vy *= 0.95;
          }
          
          if (item.y < minY) {
            item.y = minY;
            item.vy *= -0.8;
            item.vx *= 0.95;
          } else if (item.y > maxY) {
            item.y = maxY;
            // ë°”ë‹¥ì— ë‹¿ì•˜ì„ ë•Œ ìœ„ë¡œ íŠ•ê¸°ëŠ” í˜ì„ í™œë™ì„±ì— ë”°ë¼ ì œê±°
            if (activity < 0.2) {
              // í™œë™ì„±ì´ ë‚®ìœ¼ë©´ ìœ„ë¡œ íŠ•ê¸°ì§€ ì•Šê³  ë°”ë‹¥ì— ê³ ì •
              item.vy = 0;
              item.vx *= 0.9; // ìˆ˜í‰ ì†ë„ë§Œ ê°ì‡ 
            } else {
              item.vy *= -0.8;
              item.vx *= 0.95;
            }
          }
          
          // ë‹¤ë¥¸ ì•„ì´í…œê³¼ì˜ ì¶©ëŒ ê°ì§€ (ê°•í™”ëœ ì¶©ëŒ ë°©ì§€, ë°”ë‹¥ ìŒ“ì„ ê°œì„ )
          for (let j = i + 1; j < items.length; j++) {
            const other = items[j];
            const dx = item.x - other.x;
            const dy = item.y - other.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            // ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ ì—¬ìœ  ê³µê°„ ì¶”ê°€ (ê²¹ì¹¨ ë°©ì§€)
            const safetyMargin = 10; // ì¶”ê°€ ì—¬ìœ  ê³µê°„ (í”½ì…€)
            const minDistance = item.radius + other.radius + safetyMargin;
            
            if (distance < minDistance && distance > 0) {
              // ì¶©ëŒ ë°œìƒ!
              const angle = Math.atan2(dy, dx);
              const overlap = minDistance - distance;
              
              // ê° ì•„ì´í…œì˜ í™œë™ì„± í™•ì¸
              const itemAge = (currentTime - item.birthTime) / 1000;
              const otherAge = (currentTime - other.birthTime) / 1000;
              const itemTotalAge = item.age + itemAge;
              const otherTotalAge = other.age + otherAge;
              const itemActivity = itemTotalAge > 600 ? Math.max(0, 1 - (itemTotalAge - 600) / 600) : 1.0;
              const otherActivity = otherTotalAge > 600 ? Math.max(0, 1 - (otherTotalAge - 600) / 600) : 1.0;
              
              // ë°”ë‹¥ ê·¼ì²˜ì—ì„œì˜ ì¶©ëŒ ì²˜ë¦¬ ê°œì„ 
              const itemNearBottom = item.y > maxY - itemSize * 0.5;
              const otherNearBottom = other.y > maxY - itemSize * 0.5;
              
              // ì•„ì´í…œì„ ê°•ì œë¡œ ë¶„ë¦¬ (ê²¹ì¹¨ ì™„ì „ ë°©ì§€)
              let separationX = Math.cos(angle) * overlap * 0.6;
              let separationY = Math.sin(angle) * overlap * 0.6;
              
              // ë°”ë‹¥ ê·¼ì²˜ì—ì„œëŠ” ìˆ˜í‰ ë°©í–¥ìœ¼ë¡œë§Œ ë¶„ë¦¬ (ìˆ˜ì§ ë¶„ë¦¬ ìµœì†Œí™”)
              if (itemNearBottom && otherNearBottom) {
                // ë‘˜ ë‹¤ ë°”ë‹¥ ê·¼ì²˜ë©´ ìˆ˜í‰ìœ¼ë¡œë§Œ ë¶„ë¦¬
                separationY *= 0.3; // ìˆ˜ì§ ë¶„ë¦¬ ìµœì†Œí™”
                separationX *= 1.2; // ìˆ˜í‰ ë¶„ë¦¬ëŠ” ê°•í™”
              } else if (itemNearBottom) {
                // itemë§Œ ë°”ë‹¥ ê·¼ì²˜ë©´ itemì€ ìˆ˜ì§ìœ¼ë¡œ ì›€ì§ì´ì§€ ì•ŠìŒ
                separationY = Math.max(0, separationY); // itemì€ ì•„ë˜ë¡œ ë‚´ë ¤ê°€ì§€ ì•ŠìŒ
              } else if (otherNearBottom) {
                // otherë§Œ ë°”ë‹¥ ê·¼ì²˜ë©´ otherëŠ” ìˆ˜ì§ìœ¼ë¡œ ì›€ì§ì´ì§€ ì•ŠìŒ
                separationY = Math.min(0, separationY); // otherëŠ” ì•„ë˜ë¡œ ë‚´ë ¤ê°€ì§€ ì•ŠìŒ
              }
              
              item.x += separationX;
              item.y += separationY;
              other.x -= separationX;
              other.y -= separationY;
              
              // ë°˜ë°œ ì†ë„ ê³„ì‚°
              const relativeVx = item.vx - other.vx;
              const relativeVy = item.vy - other.vy;
              const relativeSpeed = Math.cos(angle) * relativeVx + Math.sin(angle) * relativeVy;
              
              if (relativeSpeed > 0) {
                // ê° ì•„ì´í…œì˜ í™œë™ì„± ê³„ì‚°
                const itemAge = (currentTime - item.birthTime) / 1000;
                const otherAge = (currentTime - other.birthTime) / 1000;
                const itemTotalAge = item.age + itemAge;
                const otherTotalAge = other.age + otherAge;
                const itemActivity = itemTotalAge > 600 ? Math.max(0, 1 - (itemTotalAge - 600) / 600) : 1.0;
                const otherActivity = otherTotalAge > 600 ? Math.max(0, 1 - (otherTotalAge - 600) / 600) : 1.0;
                const avgActivity = (itemActivity + otherActivity) / 2;
                
                // íŠ•ê¹€ í˜ ê³„ì‚° (í™œë™ì„±ì— ë¹„ë¡€)
                const baseBounceStrength = Math.min(relativeSpeed * 20, 15); // íŠ•ê¹€ í˜ ì¦ê°€ (15 â†’ 20, 10 â†’ 15)
                const bounceStrength = baseBounceStrength * avgActivity; // í™œë™ì„±ì´ ë‚®ì„ìˆ˜ë¡ íŠ•ê¹€ ì•½í•¨
                const bounceX = Math.cos(angle) * bounceStrength;
                const bounceY = Math.sin(angle) * bounceStrength;
                
                // íŠ•ê¹€ íš¨ê³¼ ì ìš© (í™œë™ì„±ì— ë¹„ë¡€)
                item.bounceForce = { x: bounceX, y: bounceY };
                item.bounceTime = Math.floor(80 * avgActivity); // í™œë™ì„±ì— ë¹„ë¡€í•˜ì—¬ ì§€ì† ì‹œê°„ ê°ì†Œ (60 â†’ 80)
                item.vx += bounceX * 0.9 * itemActivity; // í™œë™ì„±ì— ë¹„ë¡€ (0.7 â†’ 0.9)
                item.vy += bounceY * 0.9 * itemActivity;
                // íŠ•ê¹€ ì‹œ íšŒì „ë„ í™œë™ì„±ì— ë¹„ë¡€
                item.rotate += (Math.random() - 0.5) * 15 * itemActivity;
                
                other.bounceForce = { x: -bounceX, y: -bounceY };
                other.bounceTime = Math.floor(80 * avgActivity);
                other.vx -= bounceX * 0.9 * otherActivity;
                other.vy -= bounceY * 0.9 * otherActivity;
                other.rotate += (Math.random() - 0.5) * 15 * otherActivity;
              }
            }
          }
          
          // CSS transform ì—…ë°ì´íŠ¸ (ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ + íšŒì „)
          // translateZ(0)ì„ ì‚¬ìš©í•˜ì—¬ GPU ê°€ì† í™œìš©
          if (item.isHovered) {
            // hover ì‹œ scale ì ìš© ë° ì•½ê°„ ìœ„ë¡œ
            item.element.style.transform = `translate3d(${item.x}px, ${item.y - 15}px, 0) rotate(${item.rotate}deg) scale(1.15)`;
          } else {
            item.element.style.transform = `translate3d(${item.x}px, ${item.y}px, 0) rotate(${item.rotate}deg)`;
          }
          item.element.style.willChange = 'transform';
          
          // íšŒì „ë„ ì‚´ì§ ë³€ë™ (íŠ•ê¹€ ì‹œ ì¶”ê°€ íšŒì „)
          if (item.bounceTime > 0) {
            item.rotate += (Math.random() - 0.5) * 2;
          }
          
          // ì†ë„ ê°ì†Œ (ë§ˆì°°) - í™œë™ì„±ì— ë¹„ë¡€í•˜ì—¬ ê°ì†Œ
          // í™œë™ì„±ì´ ë†’ìœ¼ë©´ ì²œì²œíˆ ê°ì†Œ, ë‚®ìœ¼ë©´ ë¹ ë¥´ê²Œ ê°ì†Œ
          const friction = 0.99 + (1 - activity) * 0.008; // 0.99 ~ 0.998
          item.vx *= friction;
          item.vy *= friction;
          
          // íšŒì „ë„ ê±°ì˜ ë³€ë™í•˜ì§€ ì•ŠìŒ (ì¶©ëŒ ì‹œì—ë§Œ íšŒì „)
          // item.rotate += (Math.random() - 0.5) * 0.3; // ì œê±°
        });
        
        animationFrameId = requestAnimationFrame(updatePhysics);
      }
      
      console.log('âœ… ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ ë£¨í”„ ì‹œì‘');
      updatePhysics();
    }
    
    // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ ì• ë‹ˆë©”ì´ì…˜ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
      }
    });
    
    // í‹°ì¼“ ìƒì„¸ ë³´ê¸° (ë‚˜ì¤‘ì— êµ¬í˜„ ê°€ëŠ¥)
    function viewTicket(ticketId) {
      console.log('í‹°ì¼“ ë³´ê¸°:', ticketId);
      // TODO: í‹°ì¼“ ìƒì„¸ ëª¨ë‹¬ ë˜ëŠ” í˜ì´ì§€ êµ¬í˜„
    }
    
    // ì•„ì¹´ì´ë¸Œ ì „ì²´ ì‚­ì œ
    function clearArchive() {
      if (confirm('ì •ë§ë¡œ ëª¨ë“  ì•„ì¹´ì´ë¸Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        localStorage.removeItem(ARCHIVE_KEY);
        localStorage.removeItem('portato_selections');
        localStorage.removeItem('portatoCurrentStep');
        console.log('ğŸ§¹ ëª¨ë“  ì•„ì¹´ì´ë¸Œ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ');
        loadArchive();
        alert('ì•„ì¹´ì´ë¸Œê°€ ë¹„ì›Œì¡ŒìŠµë‹ˆë‹¤.');
      }
    }
    
    // ì•„ì¹´ì´ë¸Œ ìë™ ìƒˆë¡œê³ ì¹¨ ê´€ë¦¬
    let lastArchiveCount = 0;
    let archiveUpdateCheckInterval = null;
    let broadcastChannel = null;
    
    // ì•„ì¹´ì´ë¸Œ ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜
    function refreshArchive() {
      console.log('ğŸ”„ ì•„ì¹´ì´ë¸Œ ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');
      const archiveData = JSON.parse(localStorage.getItem(ARCHIVE_KEY) || '[]');
      const currentCount = archiveData.length;
      
      // ê°œìˆ˜ê°€ ë³€ê²½ë˜ì—ˆê±°ë‚˜, ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì€ ê²½ìš° ìƒˆë¡œê³ ì¹¨
      if (currentCount !== lastArchiveCount || lastArchiveCount === 0) {
        console.log(`ğŸ“Š ì•„ì¹´ì´ë¸Œ ê°œìˆ˜ ë³€ê²½: ${lastArchiveCount} â†’ ${currentCount}`);
        lastArchiveCount = currentCount;
        loadArchive();
      } else {
        console.log('ğŸ“Š ì•„ì¹´ì´ë¸Œ ê°œìˆ˜ ë³€ê²½ ì—†ìŒ, ìƒˆë¡œê³ ì¹¨ ê±´ë„ˆëœ€');
      }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', function() {
      // ì´ˆê¸° ì•„ì¹´ì´ë¸Œ ê°œìˆ˜ ì €ì¥
      const initialArchiveData = JSON.parse(localStorage.getItem(ARCHIVE_KEY) || '[]');
      lastArchiveCount = initialArchiveData.length;
      
      loadArchive();
      
      // BroadcastChannelì„ í†µí•œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê°ì§€
      try {
        broadcastChannel = new BroadcastChannel('portato_archive');
        broadcastChannel.onmessage = function(event) {
          if (event.data && event.data.type === 'archive_updated') {
            console.log('ğŸ“¢ ì•„ì¹´ì´ë¸Œ ì—…ë°ì´íŠ¸ ì•Œë¦¼ ìˆ˜ì‹ :', event.data);
            // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ìƒˆë¡œê³ ì¹¨ (ì €ì¥ì´ ì™„ë£Œë  ì‹œê°„ì„ ì¤Œ)
            setTimeout(() => {
              refreshArchive();
            }, 500);
          }
        };
        console.log('âœ… BroadcastChannel ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
      } catch (channelError) {
        console.warn('âš ï¸ BroadcastChannel ì‚¬ìš© ì‹¤íŒ¨, polling ë°©ì‹ìœ¼ë¡œ ì „í™˜:', channelError);
      }
      
      // storage ì´ë²¤íŠ¸ ê°ì§€ (ë‹¤ë¥¸ íƒ­/ìœˆë„ìš°ì—ì„œ localStorage ë³€ê²½ ì‹œ)
      window.addEventListener('storage', function(event) {
        if (event.key === ARCHIVE_KEY || event.key === 'portato_archive_updated') {
          console.log('ğŸ“¢ storage ì´ë²¤íŠ¸ ê°ì§€:', event.key);
          // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ìƒˆë¡œê³ ì¹¨
          setTimeout(() => {
            refreshArchive();
          }, 300);
        }
      });
      
      // ì£¼ê¸°ì  ì²´í¬ (30ì´ˆë§ˆë‹¤) - BroadcastChannelì´ ì‘ë™í•˜ì§€ ì•ŠëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„
      archiveUpdateCheckInterval = setInterval(() => {
        refreshArchive();
      }, 30000); // 30ì´ˆë§ˆë‹¤ ì²´í¬
      console.log('âœ… ì£¼ê¸°ì  ì•„ì¹´ì´ë¸Œ ì²´í¬ ì‹œì‘ (30ì´ˆ ê°„ê²©)');
      
      // í˜ì´ì§€ê°€ ë¡œë“œëœ í›„ 10ì´ˆ ë’¤ì— ë§ˆì§€ë§‰ìœ¼ë¡œ ë³¸ timestamp ì—…ë°ì´íŠ¸
      // (ìƒˆë¡œìš´ ì•„ì´í…œì´ ìˆê³  ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚œ í›„ì—ë§Œ ì—…ë°ì´íŠ¸ë˜ë„ë¡ ì´ë¯¸ ìœ„ì—ì„œ ì²˜ë¦¬ë¨)
      // í•˜ì§€ë§Œ í˜ì´ì§€ë¥¼ ë– ë‚  ë•ŒëŠ” í˜„ì¬ ìµœì‹  timestampë¡œ ì—…ë°ì´íŠ¸
      window.addEventListener('beforeunload', function() {
        // ì •ë¦¬ ì‘ì—…
        if (broadcastChannel) {
          broadcastChannel.close();
        }
        if (archiveUpdateCheckInterval) {
          clearInterval(archiveUpdateCheckInterval);
        }
        
        const archiveData = JSON.parse(localStorage.getItem(ARCHIVE_KEY) || '[]');
        if (archiveData.length > 0) {
          const sortedData = archiveData.sort((a, b) => b.timestamp - a.timestamp);
          const currentLatestTimestamp = sortedData[0].timestamp;
          const lastViewedTimestamp = parseInt(localStorage.getItem(LAST_VIEWED_KEY) || '0');
          // í˜„ì¬ ìµœì‹  ì•„ì´í…œì´ ì´ë¯¸ ë³¸ ê²ƒë³´ë‹¤ ìµœì‹ ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
          if (currentLatestTimestamp <= lastViewedTimestamp) {
            localStorage.setItem(LAST_VIEWED_KEY, currentLatestTimestamp.toString());
          }
        }
      });
    });
  </script>
</body>
</html>
